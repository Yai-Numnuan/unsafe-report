<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#DC2626">
  <title>Unsafe-Report - ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- Firebase SDK v9 (compat) - ‡∏à‡∏≤‡∏Å jsDelivr CDN -->
  <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-app-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@9.23.0/firebase-database-compat.js"></script>
  
  <style>
    input,select,textarea{font-size:16px!important}
    html{scroll-behavior:smooth}
    *{scrollbar-width:thin;scrollbar-color:#DC2626 #f1f1f1}
    *::-webkit-scrollbar{width:8px}
    *::-webkit-scrollbar-track{background:#f1f1f1}
    *::-webkit-scrollbar-thumb{background:#DC2626;border-radius:4px}
    .modal{display:none;position:fixed;inset:0;z-index:50;background:rgba(0,0,0,0.5);align-items:center;justify-content:center}
    .modal.active{display:flex}
    .image-modal{display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;padding:20px}
    .image-modal.active{display:flex}
    .image-modal img{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px}
    .image-modal-close{position:absolute;top:20px;right:20px;background:white;color:#DC2626;padding:10px 20px;border-radius:50px;font-weight:bold;cursor:pointer;font-size:18px}
    .image-modal-close:hover{background:#DC2626;color:white}
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script>
  // ================== FIREBASE CONFIG ==================
  const firebaseConfig = {
    apiKey: "AIzaSyAoA4ytxX6RUqiMzLnL7tXsW6oMACrezqg",
    authDomain: "unsafe-report.firebaseapp.com",
    databaseURL: "https://unsafe-report-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "unsafe-report",
    storageBucket: "unsafe-report.firebasestorage.app",
    messagingSenderId: "532961833574",
    appId: "1:532961833574:web:69aed7c313c010403133a7"
  };
  
  // Initialize Firebase (‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô)
  let firebaseApp;
  let database;
  let isFirebaseReady = false;
  
  // ================== DATA ==================
  const IMGBB_API_KEY = 'eb2ee72c284a3fd3100d350fc1971f24';
  
  const ORGANIZATIONS = {
    '‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô': ['‡∏ú‡∏Å‡∏™.', '‡∏ú‡∏õ‡∏ö.', '‡∏ú‡∏°‡∏ï.', '‡∏ú‡∏ö‡∏™.', '‡∏ú‡∏ö‡∏£.', '‡∏ú‡∏™‡∏ô.', '‡∏ú‡∏Ñ‡∏û.', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
    '‡∏Å‡∏ü‡∏™.‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á': ['‡∏ú‡∏õ‡∏£.', '‡∏ú‡∏ö‡∏Ñ.', '‡∏ú‡∏ö‡∏á.', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
    '‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Æ‡πà‡∏á': ['‡∏ú‡∏õ‡∏£.', '‡∏ú‡∏ö‡∏Ñ.', '‡∏ú‡∏ö‡∏á.', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
    '‡∏Å‡∏ü‡∏™.‡∏•‡∏µ‡πâ': ['‡∏ú‡∏õ‡∏£.', '‡∏ú‡∏ö‡∏Ñ.', '‡∏ú‡∏ö‡∏á.', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
    '‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡∏ò‡∏¥': ['‡∏ú‡∏õ‡∏£.', '‡∏ú‡∏ö‡∏Ñ.', '‡∏ú‡∏ö‡∏á.', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
    '‡∏Å‡∏ü‡∏™.‡πÅ‡∏°‡πà‡∏ó‡∏≤': [],
    '‡∏Å‡∏ü‡∏™.‡∏ô‡∏Ñ‡∏£‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå': [],
    '‡∏Å‡∏ü‡∏™.‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏´‡∏ô‡∏≠‡∏á‡∏•‡πà‡∏≠‡∏á': [],
    '‡∏Å‡∏ü‡∏™.‡∏ó‡∏∏‡πà‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á': [],
    '‡∏Å‡∏ü‡∏™.‡πÅ‡∏°‡πà‡∏ï‡∏∑‡∏ô': [],
    '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': []
  };
  
  const RESPONSIBLE_UNITS = [
    // ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô
    {id:1,name:'‡∏ú‡∏õ‡∏ö. ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô'},
    {id:2,name:'‡∏ú‡∏Å‡∏™. ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô'},
    {id:3,name:'‡∏ú‡∏°‡∏ï. ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô'},
    {id:4,name:'‡∏ú‡∏ö‡∏™. ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô'},
    {id:5,name:'‡∏ú‡∏Ñ‡∏û. ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô'},
    {id:6,name:'‡∏ú‡∏ö‡∏£. ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô'},
    {id:7,name:'‡∏ú‡∏™‡∏ô. ‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô'},
    
    // ‡∏Å‡∏ü‡∏™.‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á
    {id:8,name:'‡∏ú‡∏õ‡∏£. ‡∏Å‡∏ü‡∏™.‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á'},
    {id:9,name:'‡∏ú‡∏ö‡∏Ñ. ‡∏Å‡∏ü‡∏™.‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á'},
    {id:10,name:'‡∏ú‡∏ö‡∏á. ‡∏Å‡∏ü‡∏™.‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á'},
    
    // ‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Æ‡πà‡∏á
    {id:11,name:'‡∏ú‡∏õ‡∏£. ‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Æ‡πà‡∏á'},
    {id:12,name:'‡∏ú‡∏ö‡∏Ñ. ‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Æ‡πà‡∏á'},
    {id:13,name:'‡∏ú‡∏ö‡∏á. ‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Æ‡πà‡∏á'},
    
    // ‡∏Å‡∏ü‡∏™.‡∏•‡∏µ‡πâ
    {id:14,name:'‡∏ú‡∏õ‡∏£. ‡∏Å‡∏ü‡∏™.‡∏•‡∏µ‡πâ'},
    {id:15,name:'‡∏ú‡∏ö‡∏Ñ. ‡∏Å‡∏ü‡∏™.‡∏•‡∏µ‡πâ'},
    {id:16,name:'‡∏ú‡∏ö‡∏á. ‡∏Å‡∏ü‡∏™.‡∏•‡∏µ‡πâ'},
    
    // ‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡∏ò‡∏¥
    {id:17,name:'‡∏ú‡∏õ‡∏£. ‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡∏ò‡∏¥'},
    {id:18,name:'‡∏ú‡∏ö‡∏Ñ. ‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡∏ò‡∏¥'},
    {id:19,name:'‡∏ú‡∏ö‡∏á. ‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡∏ò‡∏¥'},
    
    // ‡∏Å‡∏ü‡∏™.‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å
    {id:20,name:'‡∏Å‡∏ü‡∏™.‡πÅ‡∏°‡πà‡∏ó‡∏≤'},
    {id:21,name:'‡∏Å‡∏ü‡∏™.‡∏ô‡∏Ñ‡∏£‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå'},
    {id:22,name:'‡∏Å‡∏ü‡∏™.‡πÄ‡∏ß‡∏µ‡∏¢‡∏á‡∏´‡∏ô‡∏≠‡∏á‡∏•‡πà‡∏≠‡∏á'},
    {id:23,name:'‡∏Å‡∏ü‡∏™.‡∏ó‡∏∏‡πà‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á'},
    {id:24,name:'‡∏Å‡∏ü‡∏™.‡πÅ‡∏°‡πà‡∏ï‡∏∑‡∏ô'},
    
    // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    {id:25,name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}
  ];
  
  // ================== LINE CONFIG ==================
  const LINE_CONFIG = {
    channelAccessToken: '1qyn9dxvGVdoV/a8tbfY6YmMnMJIz9hkkAlyxSFTXd0mzmifLARs6LX9HLo7Ty938R2Js9euvl84PBsEAW/JsrQQOfbYUPLpnF1JlZ46drYl5iRr0ua5Cq3nFXrstM+3bUD8Pfp34EKrwosbL4ceawdB04t89/1O/w1cDnyilFU=',
    botBasicId: '@339jbzid'
  };
  
  // ================== STATE ==================
  let state = {
    page: 'home',
    reports: [],
    isAdmin: false,
    selectedReport: null,
    formData: {},
    units: RESPONSIBLE_UNITS,
    lineUsers: {}, // {userId: {userId, unitId, unitName, displayName, registeredAt}}
    selectedUnitId: null
  };
  
  // ================== IMAGE COMPRESSION & UPLOAD ==================
  async function compressImage(file, maxWidth = 1200, quality = 0.8) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          
          // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô maxWidth
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Base64 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î
          canvas.toBlob((blob) => {
            const compressedReader = new FileReader();
            compressedReader.onload = (ev) => {
              resolve(ev.target.result);
            };
            compressedReader.readAsDataURL(blob);
          }, 'image/jpeg', quality);
        };
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
  
  async function uploadToImgBB(base64Image) {
    try {
      // ‡∏•‡∏ö "data:image/jpeg;base64," ‡∏≠‡∏≠‡∏Å
      const base64Data = base64Image.split(',')[1];
      
      const formData = new FormData();
      formData.append('image', base64Data);
      
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        return data.data.url; // URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      } else {
        throw new Error('Upload failed');
      }
    } catch (error) {
      console.error('ImgBB upload error:', error);
      return null;
    }
  }
  
  // ================== FIREBASE STORAGE ==================
  async function loadReports() {
    try {
      if (!isFirebaseReady) {
        console.warn('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°, ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
        return;
      }
      
      console.log('üì• Loading reports from Firebase...');
      
      // Load Reports
      const reportsSnapshot = await database.ref('reports').once('value');
      const reportsData = reportsSnapshot.val();
      
      if (reportsData) {
        // ‡πÅ‡∏õ‡∏•‡∏á object ‡πÄ‡∏õ‡πá‡∏ô array ‡πÅ‡∏•‡∏∞ sort
        state.reports = Object.values(reportsData)
          .sort((a,b) => new Date(b.createdAt||0) - new Date(a.createdAt||0));
        console.log(`‚úÖ Loaded ${state.reports.length} reports`);
      } else {
        state.reports = [];
        console.log('üì≠ No reports yet');
      }
      
      // Load LINE Users
      const lineUsersSnapshot = await database.ref('lineUsers').once('value');
      const lineUsersData = lineUsersSnapshot.val();
      
      if (lineUsersData) {
        state.lineUsers = lineUsersData;
        console.log(`‚úÖ Loaded ${Object.keys(state.lineUsers).length} LINE users`);
      } else {
        state.lineUsers = {};
        console.log('üì≠ No LINE users yet');
      }
      
    } catch(e) {
      console.error('‚ùå Firebase load error:', e);
      state.reports = []; 
      state.lineUsers = {};
    }
    render();
  }
  
  // Setup Real-time Listeners (Sync ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
  function setupRealtimeListeners() {
    if (!isFirebaseReady) {
      console.warn('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°, ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á listeners');
      return;
    }
    
    console.log('üîÑ Setting up real-time sync...');
    
    // Listen for reports changes
    database.ref('reports').on('value', (snapshot) => {
      const reportsData = snapshot.val();
      if (reportsData) {
        state.reports = Object.values(reportsData)
          .sort((a,b) => new Date(b.createdAt||0) - new Date(a.createdAt||0));
        console.log('üîÑ Reports synced from Firebase');
        render();
      }
    });
    
    // Listen for LINE users changes
    database.ref('lineUsers').on('value', (snapshot) => {
      const lineUsersData = snapshot.val();
      if (lineUsersData) {
        state.lineUsers = lineUsersData;
        console.log('üîÑ LINE users synced from Firebase');
        // LINE users update ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á render() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ UI
      }
    });
    
    console.log('‚úÖ Real-time sync enabled!');
  }
  
  // ================== LINE MESSAGING FUNCTIONS ==================
  function saveLineUsers() {
    if (!isFirebaseReady) {
      console.warn('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
      return;
    }
    
    try {
      database.ref('lineUsers').set(state.lineUsers);
      console.log('‚úÖ LINE users saved to Firebase');
    } catch(e) {
      console.error('‚ùå Failed to save LINE users:', e);
    }
  }
  
  // ‡∏™‡πà‡∏á LINE Message ‡∏ú‡πà‡∏≤‡∏ô Webhook Server (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS)
  async function sendLineMessage(userId, message) {
    try {
      const response = await fetch('https://unsafe-report-webhook.vercel.app/api/webhook', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: 'sendMessage',
          userId: userId,
          message: message
        })
      });
      
      const result = await response.json();
      console.log('üì§ Webhook response:', result);
      
      return result.success === true;
    } catch(error) {
      console.error('Failed to send LINE message via webhook:', error);
      return false;
    }
  }
  
  // ================== ADMIN NOTIFICATION FUNCTIONS ==================
  // ‡∏´‡∏≤ LINE User ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Admin (‡∏à‡∏õ.‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û)
  function getAdminLineUsers() {
    return Object.values(state.lineUsers).filter(u => u.isAdmin === true);
  }
  
  // ‡πÅ‡∏à‡πâ‡∏á Admin ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
  async function notifyAdminNewReport(report) {
    const adminUsers = getAdminLineUsers();
    if (adminUsers.length === 0) {
      console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ Admin LINE User ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
      return false;
    }
    
    const message = {
      type: 'flex',
      altText: `üì• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ ${report.reportNumber}`,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [{
            type: 'text',
            text: 'üì• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢',
            color: '#FFFFFF',
            weight: 'bold',
            size: 'lg'
          }],
          backgroundColor: '#3B82F6',
          paddingAll: '20px'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}`,
              weight: 'bold',
              size: 'xl',
              margin: 'none'
            },
            {
              type: 'separator',
              margin: 'md'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: 'üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå',
                  color: '#3B82F6',
                  size: 'sm',
                  weight: 'bold'
                },
                {
                  type: 'text',
                  text: report.incidentDate ? new Date(report.incidentDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : '-',
                  size: 'md',
                  wrap: true
                }
              ],
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: 'üë§ ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                  color: '#3B82F6',
                  size: 'sm',
                  weight: 'bold'
                },
                {
                  type: 'text',
                  text: report.workerName || '-',
                  size: 'md',
                  wrap: true
                }
              ],
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: 'üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
                  color: '#3B82F6',
                  size: 'sm',
                  weight: 'bold'
                },
                {
                  type: 'text',
                  text: (report.description || '-').substring(0, 100) + ((report.description || '').length > 100 ? '...' : ''),
                  size: 'sm',
                  wrap: true,
                  color: '#666666'
                }
              ],
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [{
                type: 'text',
                text: '‚è≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                size: 'sm',
                color: '#F59E0B',
                weight: 'bold',
                wrap: true
              }],
              margin: 'lg',
              backgroundColor: '#FEF3C7',
              paddingAll: '12px',
              cornerRadius: '8px'
            }
          ],
          paddingAll: '20px'
        }
      }
    };
    
    let success = false;
    for (const admin of adminUsers) {
      const userId = admin.odUserId || admin.userId;
      if (userId) {
        const sent = await sendLineMessage(userId, message);
        if (sent) success = true;
        console.log(`üì§ Admin notification sent to ${admin.displayName}: ${sent ? 'success' : 'failed'}`);
      }
    }
    return success;
  }
  
  // ‡πÅ‡∏à‡πâ‡∏á Admin ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
  async function notifyAdminPendingApproval(report) {
    const adminUsers = getAdminLineUsers();
    if (adminUsers.length === 0) {
      console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ Admin LINE User ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
      return false;
    }
    
    const message = {
      type: 'flex',
      altText: `‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${report.reportNumber} ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô`,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [{
            type: 'text',
            text: '‚úÖ ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
            color: '#FFFFFF',
            weight: 'bold',
            size: 'lg'
          }],
          backgroundColor: '#10B981',
          paddingAll: '20px'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}`,
              weight: 'bold',
              size: 'xl',
              margin: 'none'
            },
            {
              type: 'separator',
              margin: 'md'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: 'üè¢ ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                  color: '#10B981',
                  size: 'sm',
                  weight: 'bold'
                },
                {
                  type: 'text',
                  text: report.assignedTo || '-',
                  size: 'md',
                  wrap: true
                }
              ],
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: 'üë§ ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                  color: '#10B981',
                  size: 'sm',
                  weight: 'bold'
                },
                {
                  type: 'text',
                  text: report.workerName || '-',
                  size: 'md',
                  wrap: true
                }
              ],
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: 'üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',
                  color: '#10B981',
                  size: 'sm',
                  weight: 'bold'
                },
                {
                  type: 'text',
                  text: `‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ ${report.resolveImages?.length || 0} ‡∏£‡∏π‡∏õ`,
                  size: 'md',
                  wrap: true
                }
              ],
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [{
                type: 'text',
                text: '‚è≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                size: 'sm',
                color: '#065F46',
                weight: 'bold',
                wrap: true
              }],
              margin: 'lg',
              backgroundColor: '#D1FAE5',
              paddingAll: '12px',
              cornerRadius: '8px'
            }
          ],
          paddingAll: '20px'
        }
      }
    };
    
    let success = false;
    for (const admin of adminUsers) {
      const userId = admin.odUserId || admin.userId;
      if (userId) {
        const sent = await sendLineMessage(userId, message);
        if (sent) success = true;
        console.log(`üì§ Admin approval notification sent to ${admin.displayName}: ${sent ? 'success' : 'failed'}`);
      }
    }
    return success;
  }

  async function sendNewReportNotification(report, unitId) {
    const unit = RESPONSIBLE_UNITS.find(u => u.id === unitId);
    if (!unit) return false;
    
    // ‡∏´‡∏≤ LINE User ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (unitId) ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (unitNames, unitName)
    const lineUsers = Object.values(state.lineUsers).filter(u => {
      // ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å unitNames (array)
      if (u.unitNames && Array.isArray(u.unitNames)) {
        return u.unitNames.includes(unit.name);
      }
      // ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å unitName (string)
      if (u.unitName) {
        return u.unitName === unit.name;
      }
      // ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤: ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å unitId
      if (u.unitId) {
        return u.unitId === unitId;
      }
      return false;
    });
    
    if (lineUsers.length === 0) {
      console.log('No LINE user registered for unit:', unit.name);
      return false;
    }
    
    const message = {
      type: 'flex',
      altText: `üö® ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ${report.reportNumber}`,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [{
            type: 'text',
            text: 'üö® ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
            color: '#FFFFFF',
            weight: 'bold',
            size: 'lg'
          }],
          backgroundColor: '#DC2626',
          paddingAll: '20px'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}`,
              weight: 'bold',
              size: 'xl',
              margin: 'none'
            },
            {
              type: 'separator',
              margin: 'md'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: 'üî¥ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå',
                  color: '#DC2626',
                  size: 'sm',
                  weight: 'bold'
                },
                {
                  type: 'text',
                  text: report.incidentDate ? new Date(report.incidentDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : '-',
                  size: 'md',
                  color: '#DC2626',
                  weight: 'bold',
                  wrap: true
                }
              ],
              margin: 'lg'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: '‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô',
                  color: '#999999',
                  size: 'sm'
                },
                {
                  type: 'text',
                  text: report.workerName || '-',
                  size: 'md',
                  wrap: true
                }
              ],
              margin: 'md'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô',
                  color: '#999999',
                  size: 'sm'
                },
                {
                  type: 'text',
                  text: report.workerUnit || '-',
                  size: 'md',
                  wrap: true
                }
              ],
              margin: 'md'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: '‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô',
                  color: '#999999',
                  size: 'sm'
                },
                {
                  type: 'text',
                  text: report.description || '-',
                  size: 'md',
                  wrap: true
                }
              ],
              margin: 'md'
            }
          ],
          paddingAll: '20px'
        },
        footer: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'button',
              action: {
                type: 'uri',
                label: 'üîó ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                uri: 'https://unsafe-report.vercel.app'
              },
              style: 'primary',
              color: '#DC2626'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [{
                type: 'text',
                text: '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô',
                size: 'xs',
                color: '#999999',
                align: 'center'
              }],
              margin: 'sm'
            }
          ],
          paddingAll: '20px'
        }
      }
    };
    
    // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å LINE user ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
    let success = false;
    for (const lineUser of lineUsers) {
      const userId = lineUser.odUserId || lineUser.userId;
      if (userId) {
        const sent = await sendLineMessage(userId, message);
        if (sent) success = true;
      }
    }
    return success;
  }
  
  async function sendApprovedNotification(report, unitId) {
    const unit = RESPONSIBLE_UNITS.find(u => u.id === unitId);
    if (!unit) return false;
    
    // ‡∏´‡∏≤ LINE User ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏°‡πà
    const lineUsers = Object.values(state.lineUsers).filter(u => {
      if (u.unitNames && Array.isArray(u.unitNames)) {
        return u.unitNames.includes(unit.name);
      }
      if (u.unitName) {
        return u.unitName === unit.name;
      }
      if (u.unitId) {
        return u.unitId === unitId;
      }
      return false;
    });
    if (lineUsers.length === 0) return false;
    
    const message = {
      type: 'flex',
      altText: `‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô ${report.reportNumber}`,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [{
            type: 'text',
            text: '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
            color: '#FFFFFF',
            weight: 'bold',
            size: 'lg'
          }],
          backgroundColor: '#059669',
          paddingAll: '20px'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}`,
              weight: 'bold',
              size: 'xl'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [{
                type: 'text',
                text: '‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
                size: 'md',
                color: '#065F46',
                wrap: true
              }],
              margin: 'lg',
              backgroundColor: '#D1FAE5',
              paddingAll: '12px',
              cornerRadius: '8px'
            }
          ],
          paddingAll: '20px'
        }
      }
    };
    
    // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å LINE user ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
    let success = false;
    for (const lineUser of lineUsers) {
      const userId = lineUser.odUserId || lineUser.userId;
      if (userId) {
        const sent = await sendLineMessage(userId, message);
        if (sent) success = true;
      }
    }
    return success;
  }
  
  async function sendReturnedNotification(report, unitId, returnReason) {
    const unit = RESPONSIBLE_UNITS.find(u => u.id === unitId);
    if (!unit) return false;
    
    // ‡∏´‡∏≤ LINE User ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏°‡πà
    const lineUsers = Object.values(state.lineUsers).filter(u => {
      if (u.unitNames && Array.isArray(u.unitNames)) {
        return u.unitNames.includes(unit.name);
      }
      if (u.unitName) {
        return u.unitName === unit.name;
      }
      if (u.unitId) {
        return u.unitId === unitId;
      }
      return false;
    });
    if (lineUsers.length === 0) return false;
    
    const message = {
      type: 'flex',
      altText: `‚Ü©Ô∏è ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${report.reportNumber}`,
      contents: {
        type: 'bubble',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [{
            type: 'text',
            text: '‚Ü©Ô∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö',
            color: '#FFFFFF',
            weight: 'bold',
            size: 'lg'
          }],
          backgroundColor: '#F59E0B',
          paddingAll: '20px'
        },
        body: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}`,
              weight: 'bold',
              size: 'xl'
            },
            {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö',
                  color: '#999999',
                  size: 'sm'
                },
                {
                  type: 'text',
                  text: returnReason || '-',
                  size: 'md',
                  wrap: true,
                  margin: 'sm'
                }
              ],
              margin: 'lg'
            }
          ],
          paddingAll: '20px'
        },
        footer: {
          type: 'box',
          layout: 'vertical',
          contents: [{
            type: 'button',
            action: {
              type: 'uri',
              label: 'üîó ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà',
              uri: 'https://unsafe-report.vercel.app'
            },
            style: 'primary',
            color: '#F59E0B'
          }],
          paddingAll: '20px'
        }
      }
    };
    
    // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏∏‡∏Å LINE user ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
    let success = false;
    for (const lineUser of lineUsers) {
      const userId = lineUser.odUserId || lineUser.userId;
      if (userId) {
        const sent = await sendLineMessage(userId, message);
        if (sent) success = true;
      }
    }
    return success;
  }
  
  async function saveReport(report) {
    if (!isFirebaseReady) {
      alert('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
      return;
    }
    
    try {
      const now = new Date();
      const yy = String(now.getFullYear() + 543).slice(-2);
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const datePrefix = yy + mm + dd;
      
      const todayReports = state.reports.filter(r => r.reportNumber?.startsWith(datePrefix));
      const runningNumber = String(todayReports.length + 1).padStart(3, '0');
      
      const reportWithNumber = {
        ...report,
        reportNumber: datePrefix + runningNumber,
        createdAt: new Date().toISOString()
      };
      
      // Save to Firebase
      await database.ref('reports/' + report.id).set(reportWithNumber);
      console.log('‚úÖ Report saved to Firebase:', reportWithNumber.reportNumber);
      
      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Admin ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
      notifyAdminNewReport(reportWithNumber).then(success => {
        console.log('üì§ Admin notification:', success ? 'sent' : 'no admin registered');
      });
      
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ' + reportWithNumber.reportNumber);
      state.page = 'home';
      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á render() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ real-time listener ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ
    } catch(e) {
      console.error('‚ùå Save error:', e);
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
    }
  }
  
  async function updateReport(reportId, updates) {
    if (!isFirebaseReady) {
      console.warn('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
      return;
    }
    
    try {
      const report = state.reports.find(r => r.id === reportId);
      if (report) {
        const updatedReport = { ...report, ...updates };
        await database.ref('reports/' + reportId).set(updatedReport);
        console.log('‚úÖ Report updated in Firebase:', reportId);
        // Real-time listener ‡∏à‡∏∞ update state ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      }
    } catch(e) {
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
    }
  }
  
  // ================== RENDER FUNCTIONS ==================
  function render() {
    const app = document.getElementById('app');
    
    if (state.page === 'home') app.innerHTML = renderHome();
    else if (state.page === 'report') app.innerHTML = renderReportForm();
    else if (state.page === 'admin') app.innerHTML = renderAdmin();
    else if (state.page === 'tracking') app.innerHTML = renderTracking();
    else if (state.page === 'unit') app.innerHTML = renderUnitDetail();
    else if (state.page === 'dashboard') app.innerHTML = renderDashboard();
    
    attachEventListeners();
  }
  
  function renderHome() {
    return `
      <div class="min-h-screen bg-gradient-to-br from-red-500 via-red-600 to-red-700 p-4 sm:p-6">
        <div class="max-w-lg mx-auto">
          <div class="bg-white rounded-3xl shadow-2xl p-6 sm:p-8 mb-6">
            <div class="text-center mb-6 sm:mb-8">
              <img src="https://i.ibb.co/GQt6SfcY/logo.png" alt="Logo" class="h-20 sm:h-24 mx-auto mb-3 sm:mb-4">
              <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Unsafe-Report</h1>
              <p class="text-sm sm:text-base text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
              <p class="text-xs sm:text-sm text-gray-500 mt-2">‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô</p>
            </div>
            
            <button onclick="navigateTo('report')" 
              class="w-full bg-red-600 text-white py-3 sm:py-4 rounded-xl text-sm sm:text-base font-semibold mb-3 hover:bg-red-700 transition-all shadow-lg">
              ‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
            </button>
            
            <button onclick="showPasswordModal()" 
              class="w-full bg-blue-600 text-white py-3 sm:py-4 rounded-xl text-sm sm:text-base font-semibold mb-3 hover:bg-blue-700 transition-all shadow-lg">
              üîê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏à‡∏õ.‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û (Admin)
            </button>
            
            <button onclick="navigateTo('tracking')" 
              class="w-full bg-orange-600 text-white py-3 sm:py-4 rounded-xl text-xs sm:text-base font-semibold mb-3 hover:bg-orange-700 transition-all shadow-lg leading-tight">
              üìã ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
            </button>
            
            <button onclick="navigateTo('dashboard')" 
              class="w-full bg-purple-600 text-white py-3 sm:py-4 rounded-xl text-sm sm:text-base font-semibold hover:bg-purple-700 transition-all shadow-lg">
              üìä Dashboard
            </button>
          </div>
          
          <div class="text-center text-white text-xs sm:text-sm">
            <p>Version 2.2 - Tracking System</p>
            <p class="mt-1">${state.reports.length} ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          </div>
        </div>
      </div>
      
      <div id="passwordModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-sm mx-4">
          <h3 class="text-xl font-bold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h3>
          <input type="password" id="adminPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" 
            class="w-full px-4 py-3 border-2 rounded-lg mb-4">
          <div class="flex gap-2">
            <button onclick="closePasswordModal()" class="flex-1 px-4 py-2 bg-gray-200 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="checkPassword()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
        </div>
      </div>
    `;
  }
  
  function renderReportForm() {
    const orgs = Object.keys(ORGANIZATIONS);
    const depts = state.formData.reporterOrg ? ORGANIZATIONS[state.formData.reporterOrg] : [];
    
    return `
      <div class="min-h-screen bg-yellow-50 p-6">
        <div class="max-w-2xl mx-auto">
          <button onclick="navigateTo('home')" class="mb-4 text-blue-600 hover:text-blue-700 font-semibold">
            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
          </button>
          
          <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8">
            <div class="text-center mb-6">
              <img src="https://i.ibb.co/GQt6SfcY/logo.png" alt="Logo" class="h-16 sm:h-20 mx-auto mb-3">
              <h1 class="text-2xl sm:text-3xl font-bold text-red-600 mb-2">Unsafe-Report</h1>
              <h2 class="text-sm sm:text-xl font-semibold text-gray-700">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
            </div>
            
            <form onsubmit="submitReport(event)" class="space-y-6">
              <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
              <div class="bg-blue-50 p-4 rounded-xl">
                <h3 class="text-lg font-bold text-blue-800 mb-4">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-semibold mb-2">
                      1. ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏≤‡∏° <span class="text-red-600">*</span>
                    </label>
                    <select id="reporterTitle" required
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500">
                      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ --</option>
                      <option value="‡∏ô‡∏≤‡∏¢" ${state.formData.reporterTitle === '‡∏ô‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ô‡∏≤‡∏¢</option>
                      <option value="‡∏ô‡∏≤‡∏á" ${state.formData.reporterTitle === '‡∏ô‡∏≤‡∏á' ? 'selected' : ''}>‡∏ô‡∏≤‡∏á</option>
                      <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß" ${state.formData.reporterTitle === '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß' ? 'selected' : ''}>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                    </select>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-semibold mb-2">
                      2. ‡∏ä‡∏∑‡πà‡∏≠ <span class="text-red-600">*</span>
                      <span class="text-xs text-gray-500">(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö)</span>
                    </label>
                    <input type="text" id="reporterFirstName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠"
                      value="${state.formData.reporterFirstName || ''}"
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-semibold mb-2">
                      3. ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-600">*</span>
                    </label>
                    <input type="text" id="reporterLastName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                      value="${state.formData.reporterLastName || ''}"
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-semibold mb-2">4. ‡∏Å‡∏ü‡∏ü.‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                    <select id="reporterOrg" required onchange="updateDepartments()"
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500">
                      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô --</option>
                      ${orgs.map(org => `<option value="${org}" ${state.formData.reporterOrg === org ? 'selected' : ''}>${org}</option>`).join('')}
                    </select>
                  </div>
                  
                  <div id="deptContainer" style="display:${depts.length > 0 ? 'block' : 'none'}">
                    <label class="block text-sm font-semibold mb-2">5. ‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                    <select id="reporterDept" ${depts.length === 0 ? 'disabled' : ''}
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${depts.length === 0 ? 'bg-gray-100' : ''}">
                      <option value="">-- ${depts.length === 0 ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å'} --</option>
                      ${depts.map(dept => `<option value="${dept}" ${state.formData.reporterDept === dept ? 'selected' : ''}>${dept}</option>`).join('')}
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö -->
              <div class="bg-orange-50 p-4 rounded-xl">
                <h3 class="text-lg font-bold text-orange-800 mb-4">üîç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</h3>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-semibold mb-2">6. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *</label>
                    <input type="date" id="incidentDate" required
                      value="${state.formData.incidentDate || new Date().toISOString().split('T')[0]}"
                      class="w-full sm:w-auto px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-orange-500 text-sm" style="max-width: 100%; min-width: 0;">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-semibold mb-2">7. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏£‡∏π‡∏õ)</label>
                    <input type="file" id="images" accept="image/*" multiple onchange="handleImages(event)"
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-orange-500 text-sm">
                    <p class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: JPG, PNG, GIF, WEBP</p>
                  </div>
                  
                  <div id="imagePreview" class="grid grid-cols-3 gap-2"></div>
                  
                  <div>
                    <label class="block text-sm font-semibold mb-2">8. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</label>
                    <textarea id="description" required rows="4" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö..."
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-orange-500">${state.formData.description || ''}</textarea>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-semibold mb-2">9. ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö (‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ)</label>
                    <input type="text" id="workerName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                      value="${state.formData.workerName || ''}"
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-orange-500">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-semibold mb-2">10. ‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                    <input type="text" id="workerUnit" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏Å‡∏ü‡∏™...."
                      value="${state.formData.workerUnit || ''}"
                      class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-orange-500">
                  </div>
                </div>
              </div>
              
              <button type="submit"
                class="w-full bg-red-600 text-white py-4 rounded-xl font-semibold hover:bg-red-700 transition-all shadow-lg text-lg">
                üì§ ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
              </button>
            </form>
          </div>
        </div>
      </div>
    `;
  }
  
  function renderAdmin() {
    const pending = state.reports.filter(r => r.status === 'pending');
    const waitingApproval = state.reports.filter(r => r.status === 'resolved');
    
    return `
      <div class="min-h-screen bg-blue-50 p-3 sm:p-6">
        <div class="max-w-6xl mx-auto">
          <!-- Brand Header -->
          <div class="bg-white rounded-xl shadow-md p-3 sm:p-4 mb-4">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
              <div class="flex items-center gap-2">
                <img src="https://i.ibb.co/GQt6SfcY/logo.png" alt="Logo" class="h-8 sm:h-10">
                <div>
                  <h1 class="text-lg sm:text-xl font-bold text-red-600">Unsafe-Report</h1>
                  <p class="text-xs sm:text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
                </div>
              </div>
              <div class="flex gap-2 sm:gap-3">
                <button onclick="showLineUserModal()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs sm:text-sm font-semibold">
                  üí¨ LINE Users
                </button>
                <button onclick="logout()" class="text-red-600 hover:text-red-700 font-semibold text-sm">‚Üê ‡∏≠‡∏≠‡∏Å</button>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8 mb-6">
            <h2 class="text-lg sm:text-2xl font-bold mb-4 sm:mb-6">üîê Admin - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</h2>
            
            ${pending.length === 0 ? `
              <div class="text-center py-12 text-gray-500">
                <p class="text-xl">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</p>
              </div>
            ` : pending.map(report => `
              <div class="border-2 rounded-xl p-4 sm:p-6 mb-4 hover:border-blue-400 transition-colors">
                <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î -->
                <div class="mb-3">
                  <span class="px-2 sm:px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs sm:text-sm font-semibold">
                    ‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
                  </span>
                </div>
                
                <div class="mb-4">
                  <h3 class="text-base sm:text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber || '-'}</h3>
                  <p class="text-xs text-blue-600 font-semibold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${report.createdAt ? new Date(report.createdAt).toLocaleString('th-TH') : '-'}</p>
                  <p class="text-xs text-red-600 font-semibold">üî¥ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${report.incidentDate ? new Date(report.incidentDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : '-'}</p>
                  <p class="text-xs sm:text-sm text-gray-600">‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${report.reporterName || '-'}</p>
                  <p class="text-xs sm:text-sm text-gray-600">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${report.reporterUnit || '-'}</p>
                </div>
                
                <div class="bg-yellow-50 border-2 border-yellow-300 p-3 sm:p-4 rounded-lg mb-4">
                  <p class="text-sm font-semibold mb-3 text-yellow-800">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</p>
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs font-semibold mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:</label>
                      <textarea id="description-${report.id}" rows="3"
                        placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô..."
                        class="w-full px-3 py-2 border-2 rounded-lg text-sm focus:ring-2 focus:ring-yellow-500">${report.description || ''}</textarea>
                    </div>
                    <div>
                      <label class="block text-xs font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:</label>
                      <input type="text" id="worker-name-${report.id}" 
                        value="${report.workerName || ''}"
                        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                        class="w-full px-3 py-2 border-2 rounded-lg text-sm focus:ring-2 focus:ring-yellow-500">
                    </div>
                    <div>
                      <label class="block text-xs font-semibold mb-1">‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</label>
                      <input type="text" id="worker-unit-${report.id}" 
                        value="${report.workerUnit || ''}"
                        placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏Å‡∏ü‡∏™...."
                        class="w-full px-3 py-2 border-2 rounded-lg text-sm focus:ring-2 focus:ring-yellow-500">
                    </div>
                  </div>
                </div>
                
                ${report.images?.length > 0 ? `
                  <div class="mb-4">
                    <p class="text-sm font-semibold mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</p>
                    <div class="grid grid-cols-3 gap-2">
                      ${report.images.map((img, idx) => `
                        <div class="relative group cursor-pointer" onclick="showImageModal('${img}')">
                          <img src="${img}" class="w-full h-24 sm:h-32 object-cover rounded-lg border-2 border-gray-300 group-hover:border-blue-500 transition-all">
                          <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 rounded-lg transition-all flex items-center justify-center">
                            <span class="text-white opacity-0 group-hover:opacity-100 text-2xl font-bold">üîç</span>
                          </div>
                          <div class="absolute bottom-1 right-1 bg-blue-600 text-white px-1 sm:px-2 py-0.5 sm:py-1 rounded text-xs font-semibold">
                            ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${idx + 1}
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
                
                <div class="flex flex-col sm:flex-row gap-2">
                  <select id="unit-${report.id}" class="w-full sm:flex-1 px-3 py-2 sm:px-4 sm:py-3 border-2 rounded-lg text-sm">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö --</option>
                    ${state.units.map(u => `
                      <option value="${u.id}">${u.name}</option>
                    `).join('')}
                  </select>
                  <div class="flex gap-2">
                    <button onclick="assignWork('${report.id}')"
                      class="flex-1 sm:flex-none px-3 sm:px-6 py-2 sm:py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 text-xs sm:text-sm font-semibold whitespace-nowrap">
                      ‚úÖ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
                    </button>
                    <button onclick="showRejectModal('${report.id}')"
                      class="flex-1 sm:flex-none px-3 sm:px-6 py-2 sm:py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 text-xs sm:text-sm font-semibold whitespace-nowrap">
                      ‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö
                    </button>
                    <button onclick="showDeleteModal('${report.id}')"
                      class="px-3 py-2 sm:px-4 sm:py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-semibold whitespace-nowrap"
                      title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          
          ${waitingApproval.length > 0 ? `
            <div class="bg-white rounded-2xl shadow-xl p-8">
              <h2 class="text-lg sm:text-2xl font-bold mb-4 sm:mb-6 text-green-700">‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</h2>
              
              ${waitingApproval.map(report => `
                <div class="border-2 border-green-300 rounded-xl p-4 sm:p-6 mb-4 hover:border-green-500 transition-colors bg-green-50">
                  <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î -->
                  <div class="mb-3">
                    <span class="px-2 sm:px-3 py-1 bg-green-200 text-green-800 rounded-full text-xs sm:text-sm font-semibold">
                      ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    </span>
                  </div>
                  
                  <div class="mb-4">
                    <h3 class="text-base sm:text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}</h3>
                    <p class="text-xs text-blue-600 font-semibold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${report.createdAt ? new Date(report.createdAt).toLocaleString('th-TH') : '-'}</p>
                    <p class="text-xs text-red-600 font-semibold">üî¥ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${report.incidentDate ? new Date(report.incidentDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : '-'}</p>
                    <p class="text-xs sm:text-sm text-gray-600">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${report.assignedTo}</p>
                    <p class="text-xs sm:text-sm text-gray-600">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(report.resolvedAt).toLocaleString('th-TH')}</p>
                    ${report.revisionCount ? `<p class="text-xs sm:text-sm text-orange-600 font-semibold">‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ${report.revisionCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>` : ''}
                  </div>
                  
                  <div class="bg-white p-3 sm:p-4 rounded-lg mb-4">
                    <p class="text-sm font-semibold mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:</p>
                    <p class="text-gray-700 text-sm">${report.description}</p>
                  </div>
                  
                  ${report.resolveImages?.length > 0 ? `
                    <div class="mb-4">
                      <p class="text-sm font-semibold mb-2 text-green-700">‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ô‡∏ö:</p>
                      <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                        ${report.resolveImages.map((img, idx) => `
                          <div class="relative group cursor-pointer" onclick="showImageModal('${img}')">
                            <img src="${img}" class="w-full h-24 sm:h-32 object-cover rounded-lg border-2 border-green-300 group-hover:border-green-500 transition-all">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 rounded-lg transition-all flex items-center justify-center">
                              <span class="text-white opacity-0 group-hover:opacity-100 text-2xl font-bold">üîç</span>
                            </div>
                            <div class="absolute bottom-1 right-1 bg-green-600 text-white px-1 sm:px-2 py-0.5 sm:py-1 rounded text-xs font-semibold">
                              ${idx + 1}
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                  
                  ${report.resolveNote ? `
                    <div class="bg-blue-50 p-3 rounded-lg mb-4">
                      <p class="text-xs font-semibold text-blue-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</p>
                      <p class="text-sm text-gray-700">${report.resolveNote}</p>
                    </div>
                  ` : ''}
                  
                  ${report.rejectHistory?.length > 0 ? `
                    <div class="bg-orange-50 p-3 rounded-lg mb-4">
                      <p class="text-xs font-semibold text-orange-700 mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö:</p>
                      ${report.rejectHistory.map((h, i) => `
                        <div class="text-xs text-gray-700 mb-1">
                          <strong>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${i + 1}:</strong> ${h.reason} <span class="text-gray-500">(${new Date(h.timestamp).toLocaleString('th-TH')})</span>
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}
                  
                  <div class="flex gap-2">
                    <button onclick="approveReport('${report.id}')"
                      class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                      ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô
                    </button>
                    <button onclick="showReturnModal('${report.id}')"
                      class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold">
                      ‚Ü©Ô∏è ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <button onclick="showDeleteModal('${report.id}')"
                      class="px-4 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-semibold"
                      title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      </div>
      
      <!-- Image Modal -->
      <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <div class="image-modal-close">‚úï ‡∏õ‡∏¥‡∏î</div>
        <img id="modalImage" src="" alt="Full Image">
      </div>
      
      <!-- Reject Modal -->
      <div id="rejectModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold mb-4 text-red-600">‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
          <p class="text-sm text-gray-600 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
          
          <div class="space-y-3 mb-4">
            <label class="flex items-start space-x-3 cursor-pointer">
              <input type="radio" name="rejectReason" value="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô" 
                class="mt-1" onchange="handleRejectReasonChange()">
              <span class="text-gray-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</span>
            </label>
            
            <label class="flex items-start space-x-3 cursor-pointer">
              <input type="radio" name="rejectReason" value="‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß" 
                class="mt-1" onchange="handleRejectReasonChange()">
              <span class="text-gray-700">‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß</span>
            </label>
            
            <label class="flex items-start space-x-3 cursor-pointer">
              <input type="radio" name="rejectReason" value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ" 
                class="mt-1" onchange="handleRejectReasonChange()">
              <span class="text-gray-700">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
            </label>
          </div>
          
          <div id="otherReasonContainer" style="display:none" class="mb-4">
            <label class="block text-sm font-semibold mb-2">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ:</label>
            <textarea id="otherReasonText" rows="3" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."
              class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-red-500"></textarea>
          </div>
          
          <div class="flex gap-2">
            <button onclick="closeRejectModal()" 
              class="flex-1 px-4 py-3 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="confirmReject()" 
              class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
            </button>
          </div>
        </div>
      </div>
      
      <!-- Return Modal -->
      <div id="returnModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold mb-4 text-orange-600">‚Ü©Ô∏è ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà</h3>
          <p class="text-sm text-gray-600 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</p>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</label>
            <textarea id="returnReason" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô, ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
              class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-orange-500"></textarea>
          </div>
          
          <div class="flex gap-2">
            <button onclick="closeReturnModal()" 
              class="flex-1 px-4 py-3 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="confirmReturn()" 
              class="flex-1 px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold">
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö
            </button>
          </div>
        </div>
      </div>
      
      <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•) -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
        <h2 class="text-2xl font-bold mb-6 text-green-600">üèÜ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•)</h2>
        
        <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
        <div class="bg-gray-50 rounded-xl p-4 mb-6 border-2 border-gray-200">
          <div class="flex flex-col md:flex-row items-start md:items-center gap-3">
            <label class="font-bold text-gray-700">üóìÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
            <select id="adminPeriodFilter" onchange="handleAdminPeriodChange(this.value)" 
              class="border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
              <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
              <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
              <option value="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</option>
              <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
            </select>
            
            <div id="adminCustomDateRange" style="display:none;" class="items-center gap-2">
              <input type="date" id="adminStartDate" 
                class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
              <span class="text-gray-600 font-semibold">‡∏ñ‡∏∂‡∏á</span>
              <input type="date" id="adminEndDate" 
                class="border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500">
              <button onclick="applyAdminCustomFilter()" 
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold shadow">
                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
            </div>
          </div>
        </div>
        
        <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
          <p class="text-sm text-gray-600">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)</p>
          <button onclick="exportAdminReporterStats()" 
            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold shadow-lg whitespace-nowrap">
            üì• Export Excel
          </button>
        </div>
        
        ${(() => {
          // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö pending)
          const filteredReports = filterReportsByDate(
            state.reports.filter(r => r.status !== 'pending'), // ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
            dashboardState.adminFilterPeriod,
            dashboardState.adminFilterStartDate,
            dashboardState.adminFilterEndDate
          );
          
          const reporterCounts = {};
          filteredReports.forEach(r => {
            const name = r.reporterName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            if (!reporterCounts[name]) {
              reporterCounts[name] = {
                name: name,
                title: r.reporterTitle || '',
                firstName: r.reporterFirstName || '',
                lastName: r.reporterLastName || '',
                unit: r.reporterUnit || '',
                count: 0
              };
            }
            reporterCounts[name].count++;
          });
          
          const topReporters = Object.values(reporterCounts)
            .sort((a, b) => b.count - a.count)
            .slice(0, 20);
          
          if (topReporters.length === 0) {
            return '<div class="text-center py-8 text-gray-500"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p></div>';
          }
          
          return `
            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="bg-green-100 border-b-2 border-green-300">
                    <th class="px-4 py-3 text-left font-bold text-sm">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                    <th class="px-4 py-3 text-left font-bold text-sm">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</th>
                    <th class="px-4 py-3 text-left font-bold text-sm">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th class="px-4 py-3 text-left font-bold text-sm">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                    <th class="px-4 py-3 text-center font-bold text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
                    <th class="px-4 py-3 text-center font-bold text-sm">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</th>
                  </tr>
                </thead>
                <tbody>
                  ${topReporters.map((r, index) => {
                    let medal = '';
                    let bgColor = '';
                    if (index === 0) {
                      medal = 'ü•á';
                      bgColor = 'bg-yellow-50';
                    } else if (index === 1) {
                      medal = 'ü•à';
                      bgColor = 'bg-gray-50';
                    } else if (index === 2) {
                      medal = 'ü•â';
                      bgColor = 'bg-orange-50';
                    } else {
                      bgColor = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    }
                    
                    return `
                      <tr class="${bgColor} border-b border-gray-200 hover:bg-green-50 transition-colors">
                        <td class="px-4 py-3 text-sm font-semibold">${index + 1}</td>
                        <td class="px-4 py-3 text-sm">${r.title}</td>
                        <td class="px-4 py-3 text-sm font-semibold">${r.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${r.unit}</td>
                        <td class="px-4 py-3 text-center">
                          <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full font-bold text-sm">
                            ${r.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                          </span>
                        </td>
                        <td class="px-4 py-3 text-center text-2xl">${medal}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            <div class="mt-4 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
              <p class="text-sm font-semibold text-blue-800">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</p>
              <ul class="text-sm text-blue-700 mt-2 space-y-1">
                <li>‚Ä¢ ‡∏Å‡∏î "Export Excel" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
                <li>‚Ä¢ ‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</li>
                <li>‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</li>
              </ul>
            </div>
          `;
        })()}
      </div>
      
      <!-- Delete Modal -->
      <div id="deleteModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold mb-4 text-red-600">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h3>
          <p class="text-sm text-gray-600 mb-4">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
          
          <div id="deleteReportInfo" class="bg-red-50 p-4 rounded-lg mb-4 text-sm">
            <p class="font-semibold text-red-800 mb-1">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö:</p>
            <p id="deleteReportNumber" class="text-gray-700"></p>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 text-red-700">
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö:
            </label>
            <input type="password" id="deletePassword" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin"
              class="w-full px-4 py-3 border-2 border-red-300 rounded-lg focus:ring-2 focus:ring-red-500">
          </div>
          
          <div class="flex gap-2">
            <button onclick="closeDeleteModal()" 
              class="flex-1 px-4 py-3 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="confirmDelete()" 
              class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
              üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö
            </button>
          </div>
        </div>
      </div>
    `;
  }
  
  function renderTracking() {
    const categories = [
      {
        name: '‡∏Å‡∏ü‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô',
        color: 'blue',
        units: RESPONSIBLE_UNITS.filter(u => u.id >= 1 && u.id <= 7)
      },
      {
        name: '‡∏Å‡∏ü‡∏™.‡∏õ‡πà‡∏≤‡∏ã‡∏≤‡∏á',
        color: 'purple',
        units: RESPONSIBLE_UNITS.filter(u => u.id >= 8 && u.id <= 10)
      },
      {
        name: '‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏Æ‡πà‡∏á',
        color: 'pink',
        units: RESPONSIBLE_UNITS.filter(u => u.id >= 11 && u.id <= 13)
      },
      {
        name: '‡∏Å‡∏ü‡∏™.‡∏•‡∏µ‡πâ',
        color: 'indigo',
        units: RESPONSIBLE_UNITS.filter(u => u.id >= 14 && u.id <= 16)
      },
      {
        name: '‡∏Å‡∏ü‡∏™.‡∏ö‡πâ‡∏≤‡∏ô‡∏ò‡∏¥',
        color: 'teal',
        units: RESPONSIBLE_UNITS.filter(u => u.id >= 17 && u.id <= 19)
      },
      {
        name: '‡∏Å‡∏ü‡∏™.(XS)',
        color: 'emerald',
        units: RESPONSIBLE_UNITS.filter(u => u.id >= 20 && u.id <= 24)
      },
      {
        name: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
        color: 'gray',
        units: RESPONSIBLE_UNITS.filter(u => u.id === 25)
      }
    ];
    
    const colorClasses = {
      blue: 'from-blue-50 to-blue-100 border-blue-300 hover:border-blue-500 group-hover:text-blue-700',
      purple: 'from-purple-50 to-purple-100 border-purple-300 hover:border-purple-500 group-hover:text-purple-700',
      pink: 'from-pink-50 to-pink-100 border-pink-300 hover:border-pink-500 group-hover:text-pink-700',
      indigo: 'from-indigo-50 to-indigo-100 border-indigo-300 hover:border-indigo-500 group-hover:text-indigo-700',
      teal: 'from-teal-50 to-teal-100 border-teal-300 hover:border-teal-500 group-hover:text-teal-700',
      emerald: 'from-emerald-50 to-emerald-100 border-emerald-300 hover:border-emerald-500 group-hover:text-emerald-700',
      gray: 'from-gray-50 to-gray-100 border-gray-300 hover:border-gray-500 group-hover:text-gray-700'
    };
    
    const headerColors = {
      blue: 'bg-blue-600 text-white',
      purple: 'bg-purple-600 text-white',
      pink: 'bg-pink-600 text-white',
      indigo: 'bg-indigo-600 text-white',
      teal: 'bg-teal-600 text-white',
      emerald: 'bg-emerald-600 text-white',
      gray: 'bg-gray-600 text-white'
    };
    
    return `
      <div class="min-h-screen bg-orange-50 p-3 sm:p-6">
        <div class="max-w-7xl mx-auto">
          <!-- Brand Header -->
          <div class="bg-white rounded-xl shadow-md p-3 sm:p-4 mb-4">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
              <div class="flex items-center gap-2">
                <img src="https://i.ibb.co/GQt6SfcY/logo.png" alt="Logo" class="h-8 sm:h-10">
                <div>
                  <h1 class="text-lg sm:text-xl font-bold text-red-600">Unsafe-Report</h1>
                  <p class="text-xs sm:text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
                </div>
              </div>
              <button onclick="navigateTo('home')" class="text-orange-600 hover:text-orange-700 font-semibold text-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8">
            <h2 class="text-xl sm:text-3xl font-bold mb-4 sm:mb-8 text-orange-700 text-center">üìã ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h2>
            
            ${categories.map(category => {
              const totalAssigned = category.units.reduce((sum, unit) => {
                return sum + state.reports.filter(r => r.status === 'assigned' && r.assignedTo === unit.name).length;
              }, 0);
              
              return `
                <div class="mb-6 sm:mb-8">
                  <div class="${headerColors[category.color]} px-4 sm:px-6 py-2 sm:py-3 rounded-t-xl flex justify-between items-center">
                    <h3 class="text-base sm:text-xl font-bold">${category.name}</h3>
                    ${totalAssigned > 0 ? `
                      <span class="bg-white bg-opacity-30 px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-semibold">
                        ${totalAssigned} ‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                      </span>
                    ` : ''}
                  </div>
                  
                  <div class="border-2 border-t-0 border-gray-200 rounded-b-xl p-3 sm:p-4">
                    <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-4">
                      ${category.units.map(unit => {
                        const assignedReports = state.reports.filter(r => 
                          r.status === 'assigned' && r.assignedTo === unit.name
                        );
                        const resolvedReports = state.reports.filter(r => 
                          (r.status === 'resolved' || r.status === 'approved') && r.assignedTo === unit.name
                        );
                        
                        return `
                          <button onclick="selectUnit(${unit.id})" 
                            class="relative bg-gradient-to-br ${colorClasses[category.color]} border-2 rounded-xl p-3 sm:p-5 hover:shadow-lg transition-all text-left group">
                            <h4 class="font-bold text-xs sm:text-lg text-gray-800 mb-2 sm:mb-3 leading-tight">
                              ${unit.name.replace(category.name === '‡∏Å‡∏ü‡∏™.(XS)' ? '' : category.name + ' ', '')}
                            </h4>
                            <div class="flex justify-center items-center text-xs sm:text-sm">
                              <div class="flex items-center gap-1">
                                <span class="text-orange-600 font-semibold text-lg sm:text-2xl">${assignedReports.length}</span>
                                <span class="text-gray-600">‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>
                              </div>
                            </div>
                            ${assignedReports.length > 0 ? `
                              <div class="absolute -top-2 -right-2 bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full shadow-lg animate-pulse">
                                ${assignedReports.length}
                              </div>
                            ` : ''}
                          </button>
                        `;
                      }).join('')}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    `;
  }
  
  function renderUnitDetail() {
    const unitId = state.selectedUnitId;
    const unit = RESPONSIBLE_UNITS.find(u => u.id === unitId);
    
    if (!unit) {
      return `<div class="p-8 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</div>`;
    }
    
    const assignedReports = state.reports.filter(r => 
      r.status === 'assigned' && r.assignedTo === unit.name
    );
    
    // ‡∏Å‡∏£‡∏≠‡∏á "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß" ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (approved date)
    const allResolvedReports = state.reports.filter(r => 
      (r.status === 'resolved' || r.status === 'approved') && r.assignedTo === unit.name
    );
    
    const resolvedReports = filterReportsByDate(
      allResolvedReports,
      dashboardState.unitFilterPeriod,
      dashboardState.unitFilterStartDate,
      dashboardState.unitFilterEndDate
    );
    
    return `
      <div class="min-h-screen bg-orange-50 p-3 sm:p-6">
        <div class="max-w-7xl mx-auto">
          <!-- Brand Header -->
          <div class="bg-white rounded-xl shadow-md p-3 sm:p-4 mb-4">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
              <div class="flex items-center gap-2">
                <img src="https://i.ibb.co/GQt6SfcY/logo.png" alt="Logo" class="h-8 sm:h-10">
                <div>
                  <h1 class="text-lg sm:text-xl font-bold text-red-600">Unsafe-Report</h1>
                  <p class="text-xs sm:text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
                </div>
              </div>
              <button onclick="navigateTo('tracking')" class="text-orange-600 hover:text-orange-700 font-semibold text-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8">
            <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) -->
            <div class="mb-4">
              <h2 class="text-lg sm:text-2xl font-bold text-orange-700">${unit.name}</h2>
            </div>
            
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏≠‡∏µ‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) -->
            <div class="flex gap-2 sm:gap-4 mb-6">
              <div class="bg-orange-50 px-3 sm:px-4 py-2 rounded-lg text-center flex-1 sm:flex-none">
                <p class="text-xl sm:text-2xl font-bold text-orange-600">${assignedReports.length}</p>
                <p class="text-xs text-gray-600">‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>
              </div>
              <div class="bg-green-50 px-3 sm:px-6 py-2 rounded-lg border-2 border-green-200 flex-1 sm:flex-none">
                <p class="text-xl sm:text-2xl font-bold text-green-600">${resolvedReports.length}</p>
                <p class="text-xs text-gray-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</p>
                
                <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
                <div class="mt-2">
                  <select id="unitPeriodFilter" onchange="handleUnitPeriodChange(this.value)" 
                    class="text-xs border border-green-300 rounded px-2 py-1 bg-white w-full">
                    <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                    <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                    <option value="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                    <option value="year" selected>‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</option>
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                  </select>
                </div>
                
                <div id="unitCustomDateRange" style="display:none;" class="mt-2 text-left">
                  <input type="date" id="unitStartDate" 
                    class="text-xs border border-green-300 rounded px-1 py-1 w-full mb-1">
                  <input type="date" id="unitEndDate" 
                    class="text-xs border border-green-300 rounded px-1 py-1 w-full mb-1">
                  <button onclick="applyUnitCustomFilter()" 
                    class="text-xs bg-green-600 text-white px-2 py-1 rounded w-full hover:bg-green-700">
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                  </button>
                </div>
              </div>
            </div>
            
            ${assignedReports.length === 0 ? `
              <div class="text-center py-12 text-gray-500">
                <p class="text-xl">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>
              </div>
            ` : `
              <div class="mb-8">
                <h3 class="text-base sm:text-xl font-bold mb-4 text-orange-700">üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h3>
                <div class="space-y-4">
                  ${assignedReports.map(report => `
                    <div class="border-2 ${report.returnReason ? 'border-orange-400 bg-orange-50' : 'border-orange-200'} rounded-xl p-4 sm:p-6 hover:border-orange-400 transition-colors">
                      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-4 gap-2">
                        <div>
                          <h4 class="text-base sm:text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}</h4>
                          <p class="text-xs text-blue-600 font-semibold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${report.createdAt ? new Date(report.createdAt).toLocaleString('th-TH') : '-'}</p>
                          <p class="text-xs text-red-600 font-semibold">üî¥ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${report.incidentDate ? new Date(report.incidentDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : '-'}</p>
                          <p class="text-xs sm:text-sm text-gray-600">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(report.assignedAt).toLocaleString('th-TH')}</p>
                          ${report.revisionCount ? `<p class="text-xs sm:text-sm text-orange-600 font-semibold">‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ${report.revisionCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>` : ''}
                        </div>
                        <span class="self-start px-2 sm:px-3 py-1 ${report.returnReason ? 'bg-orange-200 text-orange-800' : 'bg-orange-100 text-orange-800'} rounded-full text-xs sm:text-sm font-semibold whitespace-nowrap">
                          ${report.returnReason ? '‚Ü©Ô∏è ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö' : '‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'}
                        </span>
                      </div>
                      
                      ${report.returnReason ? `
                        <div class="bg-orange-100 border-2 border-orange-300 p-3 sm:p-4 rounded-lg mb-4">
                          <p class="text-xs sm:text-sm font-bold text-orange-800 mb-2">‚ö†Ô∏è Admin ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö - ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà</p>
                          <p class="text-xs sm:text-sm text-orange-700"><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${report.returnReason}</p>
                        </div>
                      ` : ''}
                      
                      ${report.rejectHistory?.length > 0 ? `
                        <div class="bg-yellow-50 p-3 rounded-lg mb-4">
                          <p class="text-xs font-semibold text-yellow-700 mb-2">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</p>
                          ${report.rejectHistory.map((h, i) => `
                            <div class="text-xs text-gray-700 mb-1">
                              <strong>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${i + 1}:</strong> ${h.reason} <span class="text-gray-500">(${new Date(h.timestamp).toLocaleString('th-TH')})</span>
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                      
                      <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <p class="text-sm font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô:</p>
                        <p class="text-gray-700">${report.description}</p>
                      </div>
                      
                      <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div><strong>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:</strong> ${report.workerName}</div>
                        <div><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${report.workerUnit}</div>
                      </div>
                      
                      ${report.images?.length > 0 ? `
                        <div class="mb-4">
                          <p class="text-sm font-semibold mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</p>
                          <div class="grid grid-cols-3 gap-2">
                            ${report.images.map((img, idx) => `
                              <div class="relative group cursor-pointer" onclick="showImageModal('${img}')">
                                <img src="${img}" class="w-full h-24 object-cover rounded-lg border-2 border-gray-300 group-hover:border-orange-500 transition-all">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 rounded-lg transition-all flex items-center justify-center">
                                  <span class="text-white opacity-0 group-hover:opacity-100 text-2xl font-bold">üîç</span>
                                </div>
                                <div class="absolute bottom-1 right-1 bg-orange-600 text-white px-2 py-1 rounded text-xs font-semibold">
                                  ${idx + 1}
                                </div>
                              </div>
                            `).join('')}
                          </div>
                        </div>
                      ` : ''}
                      
                      <div class="flex gap-2">
                        <button onclick="printWarningLetter('${report.id}')" 
                          class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                          üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                        </button>
                        
                        <button onclick="showResolveModal('${report.id}')" 
                          class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
                          ‚úÖ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô
                        </button>
                      </div>
                      
                      <button onclick="showDeleteModal('${report.id}')" 
                        class="w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-800 font-semibold mt-2">
                        üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Admin)
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            `}
            
            ${resolvedReports.length > 0 ? `
              <div>
                <h3 class="text-xl font-bold mb-4 text-green-700">‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</h3>
                <div class="space-y-3">
                  ${resolvedReports.map(report => `
                    <div class="border-2 border-green-200 rounded-lg p-4 bg-green-50">
                      <div class="flex justify-between items-start mb-2">
                        <div>
                          <p class="font-bold">${report.reportNumber}</p>
                          <p class="text-xs text-blue-600 font-semibold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${report.createdAt ? new Date(report.createdAt).toLocaleString('th-TH') : '-'}</p>
                          <p class="text-xs text-red-600 font-semibold">üî¥ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${report.incidentDate ? new Date(report.incidentDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : '-'}</p>
                          <p class="text-sm text-gray-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${report.resolvedAt ? new Date(report.resolvedAt).toLocaleString('th-TH') : '-'}</p>
                        </div>
                        <div class="flex gap-2 items-start">
                          <span class="px-3 py-1 bg-green-200 text-green-800 rounded-full text-sm font-semibold">
                            ${report.status === 'approved' ? '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‚è±Ô∏è ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}
                          </span>
                          <button onclick="showDeleteModal('${report.id}')" 
                            class="px-3 py-1 bg-gray-700 text-white rounded-lg hover:bg-gray-800 text-sm font-semibold"
                            title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                      ${report.resolveImages?.length > 0 ? `
                        <div class="mt-3">
                          <p class="text-xs font-semibold mb-2">‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</p>
                          <div class="grid grid-cols-4 gap-2">
                            ${report.resolveImages.map(img => `
                              <img src="${img}" onclick="showImageModal('${img}')" 
                                class="w-full h-20 object-cover rounded border cursor-pointer">
                            `).join('')}
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      </div>
      
      <!-- Image Modal -->
      <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <div class="image-modal-close">‚úï ‡∏õ‡∏¥‡∏î</div>
        <img id="modalImage" src="" alt="Full Image">
      </div>
      
      <!-- Resolve Modal -->
      <div id="resolveModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold mb-4 text-green-600">‚úÖ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h3>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
            <input type="file" id="resolveImages" accept="image/*" onchange="handleResolveImages(event)"
              class="w-full px-4 py-3 border-2 rounded-lg">
            <p class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: JPG, PNG</p>
          </div>
          
          <div id="resolveImagePreview" class="mb-4"></div>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <textarea id="resolveNote" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç..."
              class="w-full px-4 py-3 border-2 rounded-lg"></textarea>
          </div>
          
          <div class="flex gap-2">
            <button onclick="closeResolveModal()" 
              class="flex-1 px-4 py-3 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="confirmResolve()" 
              class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
              ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô
            </button>
          </div>
        </div>
      </div>
      
      <!-- Delete Modal -->
      <div id="deleteModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold mb-4 text-red-600">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h3>
          <p class="text-sm text-gray-600 mb-4">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
          
          <div id="deleteReportInfo" class="bg-red-50 p-4 rounded-lg mb-4 text-sm">
            <p class="font-semibold text-red-800 mb-1">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö:</p>
            <p id="deleteReportNumber" class="text-gray-700"></p>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2 text-red-700">
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö:
            </label>
            <input type="password" id="deletePassword" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin"
              class="w-full px-4 py-3 border-2 border-red-300 rounded-lg focus:ring-2 focus:ring-red-500">
          </div>
          
          <div class="flex gap-2">
            <button onclick="closeDeleteModal()" 
              class="flex-1 px-4 py-3 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="confirmDelete()" 
              class="flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">
              üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö
            </button>
          </div>
        </div>
      </div>
    `;
  }
  
  function renderDashboard() {
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    let filteredReports = filterReportsByDate(
      state.reports,
      dashboardState.filterPeriod,
      dashboardState.filterStartDate,
      dashboardState.filterEndDate
    );
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    const searchQuery = (dashboardState.searchQuery || '').trim().toLowerCase();
    if (searchQuery) {
      filteredReports = filteredReports.filter(r => {
        return (r.reportNumber || '').toLowerCase().includes(searchQuery) ||
               (r.workerName || '').toLowerCase().includes(searchQuery) ||
               (r.workerUnit || '').toLowerCase().includes(searchQuery) ||
               (r.description || '').toLowerCase().includes(searchQuery) ||
               (r.assignedTo || '').toLowerCase().includes(searchQuery);
      });
    }
    
    const total = filteredReports.length;
    const pending = filteredReports.filter(r => r.status === 'pending').length;
    const assigned = filteredReports.filter(r => r.status === 'assigned').length;
    const resolved = filteredReports.filter(r => r.status === 'resolved').length;
    const approved = filteredReports.filter(r => r.status === 'approved').length;
    const rejected = filteredReports.filter(r => r.status === 'rejected').length;
    
    const html = `
      <div class="min-h-screen bg-purple-50 p-3 sm:p-6">
        <div class="max-w-6xl mx-auto">
          <!-- Brand Header -->
          <div class="bg-white rounded-xl shadow-md p-3 sm:p-4 mb-4">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
              <div class="flex items-center gap-2">
                <img src="https://i.ibb.co/GQt6SfcY/logo.png" alt="Logo" class="h-8 sm:h-10">
                <div>
                  <h1 class="text-lg sm:text-xl font-bold text-red-600">Unsafe-Report</h1>
                  <p class="text-xs sm:text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</p>
                </div>
              </div>
              <button onclick="navigateTo('home')" class="text-purple-600 hover:text-purple-700 font-semibold text-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8">
            <h2 class="text-lg sm:text-2xl font-bold mb-4 sm:mb-6">üìä Dashboard - ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°</h2>
            
            <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ -->
            <div class="bg-gray-50 rounded-xl p-3 sm:p-4 mb-4 sm:mb-6 border-2 border-gray-200">
              <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3">
                <label class="font-bold text-gray-700 text-sm">üóìÔ∏è ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
                <select id="periodFilter" onchange="handlePeriodChange(this.value)" 
                  class="border-2 border-gray-300 rounded-lg px-3 py-2 text-sm font-semibold focus:border-purple-500 focus:outline-none">
                  <option value="all" ${dashboardState.filterPeriod === 'all' ? 'selected' : ''}>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                  <option value="today" ${dashboardState.filterPeriod === 'today' ? 'selected' : ''}>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
                  <option value="week" ${dashboardState.filterPeriod === 'week' ? 'selected' : ''}>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
                  <option value="month" ${dashboardState.filterPeriod === 'month' ? 'selected' : ''}>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
                  <option value="year" ${dashboardState.filterPeriod === 'year' ? 'selected' : ''}>‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</option>
                  <option value="custom" ${dashboardState.filterPeriod === 'custom' ? 'selected' : ''}>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                </select>
                
                <div id="customDateRange" style="display:${dashboardState.filterPeriod === 'custom' ? 'flex' : 'none'};" class="flex-col sm:flex-row items-start sm:items-center gap-2">
                  <input type="date" id="startDate" value="${dashboardState.filterStartDate || ''}" 
                    class="border-2 border-gray-300 rounded-lg px-2 py-1 sm:px-3 sm:py-2 text-sm focus:border-purple-500 focus:outline-none w-full sm:w-auto">
                  <span class="font-semibold text-sm">‡∏ñ‡∏∂‡∏á</span>
                  <input type="date" id="endDate" value="${dashboardState.filterEndDate || ''}" 
                    class="border-2 border-gray-300 rounded-lg px-2 py-1 sm:px-3 sm:py-2 text-sm focus:border-purple-500 focus:outline-none w-full sm:w-auto">
                  <button onclick="applyCustomFilter()" 
                    class="bg-blue-600 text-white px-3 py-1 sm:px-4 sm:py-2 rounded-lg hover:bg-blue-700 text-sm font-semibold">
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                  </button>
                </div>
              </div>
            </div>
            
            <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ 6 ‡∏Å‡∏•‡πà‡∏≠‡∏á -->
            <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-4 mb-6 sm:mb-8">
              <div class="bg-blue-50 p-3 sm:p-6 rounded-xl text-center border-2 border-blue-200">
                <p class="text-xl sm:text-4xl font-bold text-blue-600">${total}</p>
                <p class="text-xs text-gray-600 mt-1 sm:mt-2 font-semibold leading-tight">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
              </div>
              <div class="bg-yellow-50 p-3 sm:p-6 rounded-xl text-center border-2 border-yellow-200">
                <p class="text-xl sm:text-4xl font-bold text-yellow-600">${pending}</p>
                <p class="text-xs text-gray-600 mt-1 sm:mt-2 font-semibold leading-tight">‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</p>
              </div>
              <div class="bg-orange-50 p-3 sm:p-6 rounded-xl text-center border-2 border-orange-200">
                <p class="text-xl sm:text-4xl font-bold text-orange-600">${assigned}</p>
                <p class="text-xs text-gray-600 mt-1 sm:mt-2 font-semibold leading-tight">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
              </div>
              <div class="bg-purple-50 p-3 sm:p-6 rounded-xl text-center border-2 border-purple-200">
                <p class="text-xl sm:text-4xl font-bold text-purple-600">${resolved}</p>
                <p class="text-xs text-gray-600 mt-1 sm:mt-2 font-semibold leading-tight">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
              </div>
              <div class="bg-green-50 p-3 sm:p-6 rounded-xl text-center border-2 border-green-200">
                <p class="text-xl sm:text-4xl font-bold text-green-600">${approved}</p>
                <p class="text-xs text-gray-600 mt-1 sm:mt-2 font-semibold leading-tight">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</p>
              </div>
              <div class="bg-red-50 p-3 sm:p-6 rounded-xl text-center border-2 border-red-200">
                <p class="text-xl sm:text-4xl font-bold text-red-600">${rejected}</p>
                <p class="text-xs text-gray-600 mt-1 sm:mt-2 font-semibold leading-tight">‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö</p>
              </div>
            </div>
            
            <!-- ‡∏Å‡∏£‡∏≤‡∏ü 3 ‡∏≠‡∏±‡∏ô -->
            <h3 class="text-base sm:text-xl font-bold mb-4">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200" style="height: 300px;">
                <canvas id="statusChart"></canvas>
              </div>
              <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200" style="height: 300px;">
                <canvas id="unitChart"></canvas>
              </div>
              <div class="bg-gray-50 rounded-xl p-4 border-2 border-gray-200" style="height: 300px;">
                <canvas id="workerChart"></canvas>
              </div>
            </div>
            
            <!-- ‡∏õ‡∏∏‡πà‡∏° Export -->
            <div class="mb-4">
              <button onclick="exportCurrentData()" 
                class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold shadow-lg">
                üì• Export Excel (${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
              </button>
            </div>
            
            <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
            <div class="bg-purple-50 rounded-xl p-3 sm:p-4 mb-4 border-2 border-purple-200">
              <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3">
                <label class="font-bold text-purple-700 text-sm">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label>
                <input type="text" id="dashboardSearch" 
                  value="${dashboardState.searchQuery || ''}"
                  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô, ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..."
                  class="flex-1 border-2 border-purple-300 rounded-lg px-3 py-2 text-sm focus:border-purple-500 focus:outline-none"
                  onkeyup="handleDashboardSearch(event)">
                <button onclick="applyDashboardSearch()" 
                  class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold">
                  ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                ${searchQuery ? `
                <button onclick="clearDashboardSearch()" 
                  class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 text-sm font-semibold">
                  ‡∏•‡πâ‡∏≤‡∏á
                </button>
                ` : ''}
              </div>
              ${searchQuery ? `
              <p class="text-xs text-purple-600 mt-2">üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${dashboardState.searchQuery}": ‡∏û‡∏ö ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
              ` : ''}
            </div>
            
            <h3 class="text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${searchQuery ? `(‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)` : ''}</h3>
            ${filteredReports.length === 0 ? `
              <div class="text-center py-8 text-gray-500">
                <p>${searchQuery ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ'}</p>
              </div>
            ` : `
              <div class="space-y-3">
                ${filteredReports.slice(0, searchQuery ? 50 : 10).map(r => `
                  <div class="border-2 rounded-lg p-4 hover:border-purple-400 transition-colors cursor-pointer" onclick="showReportDetailModal('${r.id}')">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <p class="font-bold text-lg">${r.reportNumber || '-'}</p>
                        <p class="text-sm text-gray-600">üë§ ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: ${r.workerName || '-'} (${r.workerUnit || '-'})</p>
                        <p class="text-xs text-gray-500">üè¢ ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${r.assignedTo || '-'}</p>
                        <p class="text-xs text-gray-400 mt-1">üìÖ ${r.createdAt ? new Date(r.createdAt).toLocaleString('th-TH') : '-'}</p>
                        ${r.status === 'rejected' ? `<p class="text-xs text-red-600 mt-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${r.rejectedReason || '-'}</p>` : ''}
                      </div>
                      <div class="flex flex-col sm:flex-row gap-2 items-end sm:items-start">
                        <span class="px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-semibold whitespace-nowrap ${
                          r.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                          r.status === 'assigned' ? 'bg-orange-100 text-orange-800' :
                          r.status === 'resolved' ? 'bg-purple-100 text-purple-800' :
                          r.status === 'approved' ? 'bg-green-100 text-green-800' :
                          r.status === 'rejected' ? 'bg-red-100 text-red-800' :
                          'bg-gray-100 text-gray-800'
                        }">
                          ${r.status === 'pending' ? '‚è≥ ‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢' : 
                            r.status === 'assigned' ? 'üîÑ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 
                            r.status === 'resolved' ? '‚è±Ô∏è ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' :
                            r.status === 'approved' ? '‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô' :
                            r.status === 'rejected' ? '‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö' : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}
                        </span>
                        <button onclick="event.stopPropagation(); showReportDetailModal('${r.id}')" 
                          class="px-2 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-xs font-semibold">
                          üëÅÔ∏è ‡∏î‡∏π
                        </button>
                        <button onclick="event.stopPropagation(); showDeleteModal('${r.id}')" 
                          class="px-2 py-1 bg-gray-700 text-white rounded-lg hover:bg-gray-800 text-xs font-semibold"
                          title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
                ${filteredReports.length > (searchQuery ? 50 : 10) ? `
                  <p class="text-center text-sm text-gray-500 py-2">
                    ‡πÅ‡∏™‡∏î‡∏á ${searchQuery ? 50 : 10} ‡∏à‡∏≤‡∏Å ${filteredReports.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                  </p>
                ` : ''}
              </div>
            `}
          </div>
        </div>
      </div>
      
      <!-- Report Detail Modal -->
      <div id="reportDetailModal" class="modal" onclick="closeReportDetailModal()">
        <div class="bg-white rounded-2xl p-4 sm:p-6 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
          <div id="reportDetailContent">
            <!-- Content will be loaded dynamically -->
          </div>
        </div>
      </div>
      
      <!-- Delete Modal -->
      <div id="deleteModal" class="modal">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold mb-4 text-red-600">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h3>
          <p class="text-sm text-gray-600 mb-4">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
          
          <div id="deleteReportInfo" class="bg-red-50 p-4 rounded-lg mb-4 text-sm">
            <p class="font-semibold text-red-800 mb-1">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö:</p>
            <p id="deleteReportNumber" class="text-gray-700"></p>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin:</label>
            <input type="password" id="deletePassword" 
              class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-red-500 focus:outline-none"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
          </div>
          
          <div class="flex gap-3">
            <button onclick="closeDeleteModal()" 
              class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="confirmDelete()" 
              class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">
              ‡∏•‡∏ö
            </button>
          </div>
        </div>
      </div>
    `;
    
    // ‡∏£‡∏≠ DOM render ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
    setTimeout(() => {
      createStatusChart(filteredReports, 'statusChart');
      createUnitChart(filteredReports, 'unitChart');
      createWorkerChart(filteredReports, 'workerChart');
    }, 100);
    
    return html;
  }
  
  // ================== EVENT HANDLERS ==================
  function navigateTo(page) {
    state.page = page;
    state.formData = {};
    render();
  }
  
  function showPasswordModal() {
    document.getElementById('passwordModal').classList.add('active');
    setTimeout(() => document.getElementById('adminPassword').focus(), 100);
  }
  
  function closePasswordModal() {
    document.getElementById('passwordModal').classList.remove('active');
    document.getElementById('adminPassword').value = '';
  }
  
  function checkPassword() {
    const pass = document.getElementById('adminPassword').value;
    if (pass === 'admin123') {
      state.isAdmin = true;
      state.page = 'admin';
      closePasswordModal();
      render();
    } else {
      alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminPassword').focus();
    }
  }
  
  function logout() {
    if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin?')) {
      state.isAdmin = false;
      state.page = 'home';
      render();
    }
  }
  
  function updateDepartments() {
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    const reporterTitle = document.getElementById('reporterTitle')?.value || '';
    const reporterFirstName = document.getElementById('reporterFirstName')?.value || '';
    const reporterLastName = document.getElementById('reporterLastName')?.value || '';
    const org = document.getElementById('reporterOrg').value;
    
    state.formData.reporterTitle = reporterTitle;
    state.formData.reporterFirstName = reporterFirstName;
    state.formData.reporterLastName = reporterLastName;
    state.formData.reporterOrg = org;
    
    render();
    
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏á render
    if (reporterTitle) {
      document.getElementById('reporterTitle').value = reporterTitle;
    }
    if (reporterFirstName) {
      document.getElementById('reporterFirstName').value = reporterFirstName;
    }
    if (reporterLastName) {
      document.getElementById('reporterLastName').value = reporterLastName;
    }
    if (org) {
      document.getElementById('reporterOrg').value = org;
    }
  }
  
  let uploadedImages = [];
  
  async function handleImages(event) {
    const files = Array.from(event.target.files).slice(0, 3);
    uploadedImages = [];
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '<div class="col-span-3 text-center text-gray-600">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...</div>';
    
    if (files.length === 0) {
      preview.innerHTML = '';
      return;
    }
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      
      try {
        // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ
        const compressed = await compressImage(file, 1200, 0.8);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        preview.innerHTML = `<div class="col-span-3 text-center text-blue-600">üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${i + 1}/${files.length}...</div>`;
        
        // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ ImgBB
        const imageUrl = await uploadToImgBB(compressed);
        
        if (imageUrl) {
          uploadedImages.push(imageUrl);
        }
      } catch (error) {
        console.error('Image processing error:', error);
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    preview.innerHTML = '';
    uploadedImages.forEach((url, index) => {
      const div = document.createElement('div');
      div.className = 'relative';
      div.innerHTML = `
        <img src="${url}" class="w-full h-24 object-cover rounded-lg border-2 border-gray-300">
        <div class="absolute top-1 right-1 bg-green-600 text-white rounded-full px-2 py-1 text-xs font-semibold">
          ‚úì ${index + 1}
        </div>
      `;
      preview.appendChild(div);
    });
    
    if (uploadedImages.length > 0) {
      const successDiv = document.createElement('div');
      successDiv.className = 'col-span-3 text-center text-green-600 font-semibold mt-2';
      successDiv.textContent = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${uploadedImages.length} ‡∏£‡∏π‡∏õ`;
      preview.appendChild(successDiv);
    }
  }
  
  async function submitReport(event) {
    event.preventDefault();
    
    if (uploadedImages.length === 0) {
      if (!confirm('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
      }
    }
    
    const reporterTitle = document.getElementById('reporterTitle').value;
    const reporterFirstName = document.getElementById('reporterFirstName').value;
    const reporterLastName = document.getElementById('reporterLastName').value;
    const reporterOrg = document.getElementById('reporterOrg').value;
    const reporterDept = document.getElementById('reporterDept')?.value || '';
    
    // ‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°
    const reporterFullName = `${reporterTitle}${reporterFirstName} ${reporterLastName}`;
    
    const report = {
      id: Date.now().toString(),
      reporterTitle: reporterTitle,
      reporterFirstName: reporterFirstName,
      reporterLastName: reporterLastName,
      reporterName: reporterFullName, // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      reporterOrg: reporterOrg,
      reporterDept: reporterDept,
      reporterUnit: reporterOrg + (reporterDept ? ' ' + reporterDept : ''),
      incidentDate: document.getElementById('incidentDate').value,
      description: document.getElementById('description').value,
      workerName: document.getElementById('workerName').value,
      workerUnit: document.getElementById('workerUnit').value,
      images: uploadedImages, // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡πá‡∏ö URL ‡πÅ‡∏ó‡∏ô Base64
      status: 'pending'
    };
    
    await saveReport(report);
  }
  
  async function assignWork(reportId) {
    const unitId = document.getElementById('unit-' + reportId).value;
    if (!unitId) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
      return;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
    const description = document.getElementById('description-' + reportId).value.trim();
    const workerName = document.getElementById('worker-name-' + reportId).value.trim();
    const workerUnit = document.getElementById('worker-unit-' + reportId).value.trim();
    
    if (!description) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô');
      document.getElementById('description-' + reportId).focus();
      return;
    }
    
    if (!workerName) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô');
      document.getElementById('worker-name-' + reportId).focus();
      return;
    }
    
    if (!workerUnit) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô');
      document.getElementById('worker-unit-' + reportId).focus();
      return;
    }
    
    const report = state.reports.find(r => r.id === reportId);
    const unit = state.units.find(u => u.id === parseInt(unitId));
    
    const updates = {
      description: description,          // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      workerName: workerName,            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      workerUnit: workerUnit,            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      status: 'assigned',
      assignedTo: unit.name,
      assignedAt: new Date().toISOString()
    };
    
    await updateReport(reportId, updates);
    
    // ‡∏™‡πà‡∏á LINE Message
    const lineSuccess = await sendNewReportNotification({...report, ...updates}, parseInt(unitId));
    
    const lineStatus = lineSuccess ? 
      '‚úÖ ‡∏™‡πà‡∏á LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 
      '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö LINE User ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ';
    
    alert(`‚úÖ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}\n‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô: ${workerName}\n‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${workerUnit}\n‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ: ${unit.name}\n\n${lineStatus}`);
  }
  
  function attachEventListeners() {
    // Event listeners attached via onclick in HTML
    
    // Enter key for password modal
    const passInput = document.getElementById('adminPassword');
    if (passInput) {
      passInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') checkPassword();
      });
    }
    
    // ESC key to close image modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeImageModal();
    });
  }
  
  function showImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('modalImage');
    if (modal && img) {
      img.src = imageSrc;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  }
  
  function closeImageModal() {
    const modal = document.getElementById('imageModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏° Download
  function showImageWithDownload(imageSrc, filename) {
    // ‡∏•‡∏ö modal ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const existingModal = document.getElementById('imageDownloadModal');
    if (existingModal) existingModal.remove();
    
    const modalHtml = `
      <div id="imageDownloadModal" class="fixed inset-0 z-[200] bg-black bg-opacity-90 flex items-center justify-center p-4" onclick="closeImageDownloadModal()">
        <div class="relative max-w-4xl w-full" onclick="event.stopPropagation()">
          <img src="${imageSrc}" class="w-full max-h-[80vh] object-contain rounded-lg">
          <div class="absolute top-4 right-4 flex gap-2">
            <button onclick="downloadImage('${imageSrc}', '${filename}')" 
              class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold shadow-lg">
              üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            </button>
            <button onclick="closeImageDownloadModal()" 
              class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 font-semibold shadow-lg">
              ‚úï ‡∏õ‡∏¥‡∏î
            </button>
          </div>
          <p class="text-center text-white mt-4 text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ</p>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    document.body.style.overflow = 'hidden';
  }
  
  function closeImageDownloadModal() {
    const modal = document.getElementById('imageDownloadModal');
    if (modal) {
      modal.remove();
      document.body.style.overflow = 'auto';
    }
  }
  
  // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
  async function downloadImage(imageUrl, filename) {
    try {
      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'downloadLoading';
      loadingDiv.className = 'fixed inset-0 z-[300] bg-black bg-opacity-50 flex items-center justify-center';
      loadingDiv.innerHTML = '<div class="bg-white p-6 rounded-lg text-center"><p class="font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...</p></div>';
      document.body.appendChild(loadingDiv);
      
      // Fetch ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      const response = await fetch(imageUrl);
      const blob = await response.blob();
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö download
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename + '.jpg';
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      // ‡∏•‡∏ö loading
      document.getElementById('downloadLoading')?.remove();
      
    } catch (error) {
      console.error('Download error:', error);
      document.getElementById('downloadLoading')?.remove();
      
      // ‡∏ñ‡πâ‡∏≤ fetch ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÑ‡∏î‡πâ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"');
      window.open(imageUrl, '_blank');
    }
  }
  
  let currentRejectReportId = null;
  let currentResolveReportId = null;
  let currentReturnReportId = null;
  let currentDeleteReportId = null;
  let resolveImagesData = [];
  
  // ================== LINE USERS MODAL ==================
  function showLineUserModal() {
    const users = state.lineUsers || {};
    const userList = Object.entries(users);
    
    let userCards = '';
    if (userList.length === 0) {
      userCards = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>';
    } else {
      userList.forEach(function([odUserId, user]) {
        const unitNamesArr = user.unitNames || (user.units ? user.units.map(function(u) { return u.name; }) : [user.unitName]) || [];
        let unitBadges = '';
        unitNamesArr.forEach(function(name) {
          if (name) {
            unitBadges += '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs mr-1 mb-1">' + name + '</span>';
          }
        });
        
        const statusClass = user.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600';
        const statusText = user.status === 'active' ? '‚úÖ Active' : '‚è∏Ô∏è Inactive';
        const regDate = user.registeredAt ? new Date(user.registeredAt).toLocaleString('th-TH') : '-';
        const picUrl = user.pictureUrl || 'https://via.placeholder.com/50';
        
        userCards += '<div class="border rounded-lg p-3 mb-3 hover:bg-gray-50">' +
          '<div class="flex items-start gap-3">' +
            '<img src="' + picUrl + '" class="w-12 h-12 rounded-full object-cover" onerror="this.src=\'https://via.placeholder.com/50\'">' +
            '<div class="flex-1">' +
              '<div class="flex justify-between items-start">' +
                '<div>' +
                  '<p class="font-bold">' + (user.displayName || '-') + '</p>' +
                  '<p class="text-xs text-gray-500">' + (user.role || '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô') + '</p>' +
                '</div>' +
                '<div class="flex items-center gap-2">' +
                  '<span class="px-2 py-1 text-xs rounded-full ' + statusClass + '">' + statusText + '</span>' +
                  '<button onclick="deleteLineUser(\'' + odUserId + '\')" class="px-2 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs">üóëÔ∏è</button>' +
                '</div>' +
              '</div>' +
              '<div class="mt-2 flex flex-wrap gap-1">' + unitBadges + '</div>' +
              '<p class="text-xs text-gray-400 mt-1">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ' + regDate + '</p>' +
            '</div>' +
          '</div>' +
        '</div>';
      });
    }
    
    const modalHtml = '<div id="lineUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">' +
      '<div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">' +
        '<div class="bg-blue-600 text-white p-4 flex justify-between items-center">' +
          '<h3 class="text-lg font-bold">üí¨ LINE Users ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (' + userList.length + ' ‡∏Ñ‡∏ô)</h3>' +
          '<button onclick="closeLineUserModal()" class="text-2xl hover:text-gray-200">&times;</button>' +
        '</div>' +
        '<div class="p-4 overflow-y-auto max-h-[60vh]">' + userCards + '</div>' +
        '<div class="bg-gray-100 p-3 text-center">' +
          '<button onclick="closeLineUserModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">‡∏õ‡∏¥‡∏î</button>' +
        '</div>' +
      '</div>' +
    '</div>';
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  
  function closeLineUserModal() {
    const modal = document.getElementById('lineUserModal');
    if (modal) modal.remove();
  }
  
  async function deleteLineUser(odUserId) {
    const user = state.lineUsers[odUserId];
    if (!user) return;
    
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "' + user.displayName + '" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà')) return;
    
    try {
      await database.ref('lineUsers/' + odUserId).remove();
      delete state.lineUsers[odUserId];
      closeLineUserModal();
      showLineUserModal();
      alert('‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } catch (e) {
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
    }
  }
  
  function showDeleteModal(reportId) {
    currentDeleteReportId = reportId;
    const report = state.reports.find(r => r.id === reportId);
    const modal = document.getElementById('deleteModal');
    
    if (modal && report) {
      document.getElementById('deleteReportNumber').textContent = `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber || '-'}`;
      document.getElementById('deletePassword').value = '';
      modal.classList.add('active');
    }
  }
  
  function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    if (modal) {
      modal.classList.remove('active');
      currentDeleteReportId = null;
    }
  }
  
  async function confirmDelete() {
    const password = document.getElementById('deletePassword').value;
    
    if (password !== 'admin123') {
      alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
      document.getElementById('deletePassword').focus();
      return;
    }
    
    if (!isFirebaseReady) {
      alert('‚ö†Ô∏è Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
      return;
    }
    
    const report = state.reports.find(r => r.id === currentDeleteReportId);
    
    if (confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô?\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${report.status}\n\n‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!`)) {
      try {
        // ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Firebase
        await database.ref('reports/' + currentDeleteReportId).remove();
        console.log('‚úÖ Report deleted from Firebase:', currentDeleteReportId);
        
        closeDeleteModal();
        // Real-time listener ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        
        alert(`‚úÖ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}`);
      } catch(e) {
        console.error('‚ùå Delete error:', e);
        alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + e.message);
      }
    }
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }
  
  async function printWarningLetter(reportId) {
    const report = state.reports.find(r => r.id === reportId);
    if (!report) return;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isMobile = isMobileDevice();
    
    if (isMobile) {
      // ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞ Download
      await downloadWarningLetterPDF(report);
    } else {
      // ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå: ‡πÉ‡∏ä‡πâ Print dialog ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
      printWarningLetterDesktop(report);
    }
  }
  
  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå: Print ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
  function printWarningLetterDesktop(report) {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå
    const printWindow = window.open('', '_blank');
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const reportNumber = report.reportNumber || '-';
    const workerName = report.workerName || '-';
    const workerUnit = report.workerUnit || '-';
    const description = report.description || '-';
    const assignedTo = report.assignedTo || '-';
    const createdDate = report.createdAt ? new Date(report.createdAt).toLocaleString('th-TH', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit' 
    }) : '-';
    const printDate = new Date().toLocaleString('th-TH');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const html = `<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ - ` + reportNumber + `</title>
  <style>
    @media print {
      @page { 
        size: A4; 
        margin: 12mm; 
      }
      body { 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }
    
    body {
      font-family: 'Sarabun', 'TH SarabunPSK', sans-serif;
      margin: 0;
      padding: 10px;
      background: white;
      font-size: 16px;
    }
    
    .container {
      max-width: 210mm;
      margin: 0 auto;
      background: white;
      padding: 15px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 12px;
      border-bottom: 3px solid #dc2626;
      padding-bottom: 10px;
    }
    
    .header h1 {
      color: #dc2626;
      font-size: 26px;
      margin: 4px 0;
      font-weight: bold;
    }
    
    .header h2 {
      color: #374151;
      font-size: 18px;
      margin: 4px 0;
      font-weight: bold;
    }
    
    .header p {
      color: #6b7280;
      font-size: 14px;
      margin: 2px 0;
    }
    
    .doc-number {
      text-align: right;
      font-size: 14px;
      color: #374151;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .warning-badge {
      background: #fef2f2;
      border: 2px solid #dc2626;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 12px;
      text-align: center;
      font-weight: bold;
      color: #991b1b;
      font-size: 15px;
    }
    
    /* Layout 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .left-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .right-column {
      display: flex;
      align-items: flex-start;
    }
    
    .section {
      page-break-inside: avoid;
    }
    
    .section-title {
      background: #fef2f2;
      border-left: 4px solid #dc2626;
      padding: 8px 12px;
      font-weight: bold;
      font-size: 16px;
      color: #991b1b;
      margin-bottom: 10px;
    }
    
    .info-row {
      display: flex;
      margin-bottom: 8px;
      font-size: 15px;
    }
    
    .info-label {
      font-weight: bold;
      min-width: 180px;
      color: #374151;
    }
    
    .info-value {
      color: #1f2937;
      flex: 1;
    }
    
    .description-box {
      border: 1px solid #d1d5db;
      padding: 12px;
      background: #f9fafb;
      border-radius: 4px;
      font-size: 15px;
      line-height: 1.6;
      min-height: 80px;
    }
    
    .images-grid {
      display: flex;
      flex-direction: column;
      gap: 5px;
      width: 100%;
      height: 100%;
    }
    
    .image-box {
      border: 2px solid #d1d5db;
      border-radius: 4px;
      overflow: hidden;
      width: 100%;
    }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô - 1 ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà, ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
    .images-grid.img-count-1 .image-box {
      height: 350px;
    }
    .images-grid.img-count-2 .image-box {
      height: 170px;
    }
    .images-grid.img-count-3 .image-box {
      height: 110px;
    }
    
    .image-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    /* ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
    .signature-section {
      margin-top: 15px;
      page-break-inside: avoid;
    }
    
    .signature-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .signature-box {
      border: 2px solid #374151;
      padding: 15px;
      min-height: 140px;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    .signature-title {
      font-weight: bold;
      font-size: 16px;
      color: #dc2626;
      margin-bottom: 8px;
    }
    
    .signature-desc {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
      line-height: 1.5;
      flex: 1;
    }
    
    .signature-line {
      text-align: center;
      font-size: 14px;
      line-height: 1.8;
      margin-top: auto;
    }
    
    .footer {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
      font-size: 12px;
      color: #6b7280;
      line-height: 1.4;
    }
  </style>
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://i.ibb.co/GQt6SfcY/logo.png" alt="Logo" style="height: 50px; margin-bottom: 8px;">
      <h1>Unsafe-Report</h1>
      <h2>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
      <p>‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô</p>
    </div>
    
    <div class="doc-number">
      ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ` + reportNumber + `
    </div>
    
    <div class="warning-badge">
      ‚ö†Ô∏è ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    </div>
    
    <!-- Content Grid: ‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏Ç‡∏ß‡∏≤-‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
    <div class="content-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
        <div class="section">
          <div class="section-title">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
          <div class="info-row">
            <div class="info-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</div>
            <div class="info-value">` + workerName + `</div>
          </div>
          <div class="info-row">
            <div class="info-label">‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</div>
            <div class="info-value">` + workerUnit + `</div>
          </div>
        </div>
        
        <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô -->
        <div class="section">
          <div class="section-title">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</div>
          <div class="description-box">` + description + `</div>
        </div>
        
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
        <div class="section">
          <div class="section-title">‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
          <div class="info-row" style="background-color: #FEE2E2;">
            <div class="info-label" style="color: #DC2626; font-weight: bold;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:</div>
            <div class="info-value" style="color: #DC2626; font-weight: bold;">` + (report.incidentDate ? new Date(report.incidentDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : '-') + `</div>
          </div>
          <div class="info-row">
            <div class="info-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</div>
            <div class="info-value">` + createdDate + `</div>
          </div>
          <div class="info-row">
            <div class="info-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</div>
            <div class="info-value">` + assignedTo + `</div>
          </div>
        </div>
      </div>
      
      <!-- Right Column: ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
      <div class="right-column">
        ` + (report.images && report.images.length > 0 ? `
        <div class="section" style="width: 100%;">
          <div class="section-title">üì∑ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (${report.images.length} ‡∏£‡∏π‡∏õ)</div>
          <div class="images-grid img-count-${Math.min(report.images.length, 3)}">` + report.images.slice(0, 3).map((img, idx) => {
            return '<div class="image-box"><img src="' + img + '" alt="‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ' + (idx + 1) + '"></div>';
          }).join('') + `
          </div>
        </div>` : '') + `
      </div>
    </div>
    
    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠: 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå -->
    <div class="signature-section">
      <div class="signature-grid">
        <div class="signature-box">
          <div class="signature-title">‚úçÔ∏è ‡∏•‡∏á‡∏ô‡∏≤‡∏° (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)</div>
          <div class="signature-desc">
            ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
          </div>
          <div class="signature-line">
            ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ................................................... ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö<br>
            ( ` + workerName + ` )<br>
            ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ........................................................<br>
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ........... / ........... / ...........
          </div>
        </div>
        
        <div class="signature-box">
          <div class="signature-title">‚úçÔ∏è ‡∏•‡∏á‡∏ô‡∏≤‡∏° (‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)</div>
          <div class="signature-desc">
            ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏Å‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
          </div>
          <div class="signature-line">
            ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ................................................... ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤<br>
            ( ................................................... )<br>
            ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ........................................................<br>
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ........... / ........... / ...........
          </div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö Unsafe-Report | ‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô<br>
      ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ` + printDate + `
    </div>
  </div>
  
  <script type="text/javascript">
    window.onload = function() {
      window.print();
    };
  <` + `/script>
</body>
</html>`;
    
    printWindow.document.write(html);
    printWindow.document.close();
  }
  
  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞ Download
  async function downloadWarningLetterPDF(report) {
    try {
      // ‡πÅ‡∏™‡∏î‡∏á loading
      const originalPage = state.page;
      state.page = 'loading-pdf';
      render();
      
      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const reportNumber = report.reportNumber || '-';
      const workerName = report.workerName || '-';
      const workerUnit = report.workerUnit || '-';
      const description = report.description || '-';
      const assignedTo = report.assignedTo || '-';
      const createdDate = report.createdAt ? new Date(report.createdAt).toLocaleString('th-TH', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      }) : '-';
      const printDate = new Date().toLocaleString('th-TH');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á temporary container
      const container = document.createElement('div');
      container.style.position = 'absolute';
      container.style.left = '-9999px';
      container.style.width = '210mm'; // A4 width
      container.style.background = 'white';
      container.style.padding = '15px';
      
      container.innerHTML = `
        <div style="font-family: 'Sarabun', sans-serif; background: white; padding: 15px;">
          <div style="text-align: center; margin-bottom: 12px; border-bottom: 3px solid #dc2626; padding-bottom: 10px;">
            <img src="https://i.ibb.co/GQt6SfcY/logo.png" alt="Logo" style="height: 45px; margin-bottom: 6px;">
            <h1 style="color: #dc2626; font-size: 26px; margin: 4px 0; font-weight: bold;">Unsafe-Report</h1>
            <h2 style="color: #374151; font-size: 18px; margin: 4px 0; font-weight: bold;">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</h2>
            <p style="color: #6b7280; font-size: 14px; margin: 2px 0;">‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô</p>
          </div>
          
          <div style="text-align: right; font-size: 14px; color: #374151; margin-bottom: 10px; font-weight: bold;">
            ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${reportNumber}
          </div>
          
          <div style="background: #fef2f2; border: 2px solid #dc2626; padding: 10px; border-radius: 4px; margin-bottom: 12px; text-align: center; font-weight: bold; color: #991b1b; font-size: 15px;">
            ‚ö†Ô∏è ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
          </div>
          
          <div style="margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; background: #f9fafb;">
            <div style="font-weight: bold; color: #374151; margin-bottom: 6px; font-size: 16px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px;">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            <div style="margin: 4px 0; font-size: 14px;">
              <span style="font-weight: 600; color: #6b7280;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span>
              <span style="color: #374151;">${workerName}</span>
            </div>
            <div style="margin: 4px 0; font-size: 14px;">
              <span style="font-weight: 600; color: #6b7280;">‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î:</span>
              <span style="color: #374151;">${workerUnit}</span>
            </div>
          </div>
          
          <div style="margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; background: #f9fafb;">
            <div style="font-weight: bold; color: #374151; margin-bottom: 6px; font-size: 16px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px;">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
            <div style="margin: 4px 0; font-size: 14px; line-height: 1.6; color: #374151; white-space: pre-wrap;">${description}</div>
          </div>
          
          <div style="margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; background: #f9fafb;">
            <div style="font-weight: bold; color: #374151; margin-bottom: 6px; font-size: 16px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px;">‚ö° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</div>
            <div style="margin: 4px 0; font-size: 14px;">
              <span style="font-weight: 600; color: #6b7280;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</span>
              <span style="color: #374151;">${assignedTo}</span>
            </div>
            <div style="margin: 4px 0; font-size: 14px;">
              <span style="font-weight: 600; color: #6b7280;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</span>
              <span style="color: #374151;">${createdDate}</span>
            </div>
          </div>
          
          ${report.images && report.images.length > 0 ? `
          <div style="margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; background: #f9fafb;">
            <div style="font-weight: bold; color: #374151; margin-bottom: 6px; font-size: 16px;">üì∑ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (${report.images.length} ‡∏£‡∏π‡∏õ)</div>
            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
              ${report.images.slice(0, 3).map((img, idx) => {
                const imgHeight = report.images.length === 1 ? '200px' : (report.images.length === 2 ? '120px' : '80px');
                return '<img src="' + img + '" style="width: ' + (report.images.length === 1 ? '100%' : '48%') + '; height: ' + imgHeight + '; object-fit: contain; border-radius: 4px; border: 1px solid #e5e7eb;" />';
              }).join('')}
            </div>
          </div>
          ` : (report.imageUrl ? `
          <div style="margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; background: #f9fafb;">
            <div style="font-weight: bold; color: #374151; margin-bottom: 6px; font-size: 16px;">üì∑ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</div>
            <img src="${report.imageUrl}" style="max-width: 100%; height: 200px; object-fit: contain; border-radius: 4px; border: 1px solid #e5e7eb;" />
          </div>
          ` : '')}
          
          <div style="margin-top: 30px; text-align: center; font-size: 14px; line-height: 1.8;">
            <div style="margin-bottom: 40px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ........................................ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</div>
            <div style="margin-bottom: 5px;">(.........................................)</div>
            <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ......./......./.......</div>
          </div>
          
          <div style="margin-top: 30px; text-align: center; font-size: 14px; line-height: 1.8;">
            <div style="margin-bottom: 40px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ........................................ ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>
            <div style="margin-bottom: 5px;">(.........................................)</div>
            <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ......./......./.......</div>
          </div>
          
          <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 12px; color: #6b7280; line-height: 1.4;">
            ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö Unsafe-Report | ‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô<br>
            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${printDate}
          </div>
        </div>
      `;
      
      document.body.appendChild(container);
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
      const canvas = await html2canvas(container, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
      });
      
      // ‡∏•‡∏ö temporary container
      document.body.removeChild(container);
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏à‡∏≤‡∏Å canvas
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      const imgWidth = 210; // A4 width in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
      
      // Download PDF
      pdf.save(`‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô-${reportNumber}.pdf`);
      
      // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
      state.page = originalPage;
      render();
      
      alert('‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Downloads');
      
    } catch (error) {
      console.error('PDF generation error:', error);
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF: ' + error.message);
      state.page = 'home';
      render();
    }
  }
  
  function selectUnit(unitId) {
    // ‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
    const password = prompt('üîê ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:');
    
    if (password === null) {
      // ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      return;
    }
    
    if (password !== 'pea123') {
      alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
      return;
    }
    
    // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    state.selectedUnitId = unitId;
    state.page = 'unit';
    render();
  }
  
  function showResolveModal(reportId) {
    currentResolveReportId = reportId;
    const modal = document.getElementById('resolveModal');
    if (modal) {
      modal.classList.add('active');
      resolveImagesData = [];
      document.getElementById('resolveImages').value = '';
      document.getElementById('resolveNote').value = '';
      document.getElementById('resolveImagePreview').innerHTML = '';
    }
  }
  
  function closeResolveModal() {
    const modal = document.getElementById('resolveModal');
    if (modal) {
      modal.classList.remove('active');
      currentResolveReportId = null;
      resolveImagesData = [];
    }
  }
  
  async function handleResolveImages(event) {
    const files = Array.from(event.target.files).slice(0, 1); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏£‡∏π‡∏õ
    resolveImagesData = [];
    const preview = document.getElementById('resolveImagePreview');
    preview.innerHTML = '<div class="text-center text-gray-600">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...</div>';
    
    if (files.length === 0) {
      preview.innerHTML = '';
      return;
    }
    
    const file = files[0];
    
    try {
      // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ
      const compressed = await compressImage(file, 1200, 0.8);
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
      preview.innerHTML = `<div class="text-center text-blue-600">üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...</div>`;
      
      // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ ImgBB
      const imageUrl = await uploadToImgBB(compressed);
      
      if (imageUrl) {
        resolveImagesData.push(imageUrl);
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        preview.innerHTML = `
          <div class="relative max-w-md mx-auto">
            <img src="${imageUrl}" class="w-full h-64 object-contain rounded-lg border-2 border-green-300">
            <div class="absolute top-2 right-2 bg-green-600 text-white rounded-full px-3 py-1 text-sm font-semibold">
              ‚úì ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            </div>
          </div>
        `;
      } else {
        preview.innerHTML = '<div class="text-center text-red-600">‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>';
      }
    } catch (error) {
      console.error('Image processing error:', error);
      preview.innerHTML = '<div class="text-center text-red-600">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</div>';
    }
  }
  
  async function confirmResolve() {
    if (resolveImagesData.length === 0) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
      return;
    }
    
    const note = document.getElementById('resolveNote').value.trim();
    const report = state.reports.find(r => r.id === currentResolveReportId);
    
    if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç?\n\n‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}\n\n‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô`)) {
      const updates = {
        status: 'resolved',
        resolveImages: resolveImagesData,
        resolveNote: note,
        resolvedAt: new Date().toISOString()
      };
      
      await updateReport(currentResolveReportId, updates);
      
      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Admin ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
      notifyAdminPendingApproval({...report, ...updates}).then(success => {
        console.log('üì§ Admin approval notification:', success ? 'sent' : 'no admin registered');
      });
      
      closeResolveModal();
      
      alert(`‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n\n‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}\n\n‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô`);
    }
  }
  
  function showReturnModal(reportId) {
    currentReturnReportId = reportId;
    const modal = document.getElementById('returnModal');
    if (modal) {
      modal.classList.add('active');
      document.getElementById('returnReason').value = '';
    }
  }
  
  function closeReturnModal() {
    const modal = document.getElementById('returnModal');
    if (modal) {
      modal.classList.remove('active');
      currentReturnReportId = null;
    }
  }
  
  async function confirmReturn() {
    const reason = document.getElementById('returnReason').value.trim();
    
    if (!reason) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
      document.getElementById('returnReason').focus();
      return;
    }
    
    const report = state.reports.find(r => r.id === currentReturnReportId);
    
    if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${report.reportNumber}?\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}\n\n‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ${report.assignedTo} ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà`)) {
      const rejectHistory = report.rejectHistory || [];
      rejectHistory.push({
        reason: reason,
        timestamp: new Date().toISOString()
      });
      
      const updates = {
        status: 'assigned', // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô assigned
        resolveImages: [], // ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤
        resolveNote: '',
        returnReason: reason,
        revisionCount: (report.revisionCount || 0) + 1,
        rejectHistory: rejectHistory
      };
      
      await updateReport(currentReturnReportId, updates);
      
      // ‡∏´‡∏≤ unitId ‡∏à‡∏≤‡∏Å assignedTo ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á LINE
      const unit = RESPONSIBLE_UNITS.find(u => u.name === report.assignedTo);
      if (unit) {
        await sendReturnedNotification({...report, ...updates}, unit.id, reason);
      }
      
      closeReturnModal();
      
      alert(`‚úÖ ‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}\n‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö: ${report.assignedTo}\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}\n\n‚úÖ ‡∏™‡πà‡∏á LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß`);
    }
  }
  
  async function approveReport(reportId) {
    const report = state.reports.find(r => r.id === reportId);
    
    if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${report.reportNumber}?`)) {
      const updates = {
        status: 'approved',
        approvedAt: new Date().toISOString()
      };
      
      await updateReport(reportId, updates);
      
      // ‡∏´‡∏≤ unitId ‡∏à‡∏≤‡∏Å assignedTo
      const unit = RESPONSIBLE_UNITS.find(u => u.name === report.assignedTo);
      if (unit) {
        await sendApprovedNotification({...report, ...updates}, unit.id);
      }
      
      alert(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n\n‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}\n‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô: ${report.assignedTo}\n\n‚úÖ ‡∏™‡πà‡∏á LINE ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß`);
    }
  }
  
  function showRejectModal(reportId) {
    currentRejectReportId = reportId;
    const modal = document.getElementById('rejectModal');
    if (modal) {
      modal.classList.add('active');
      // Reset form
      document.querySelectorAll('input[name="rejectReason"]').forEach(r => r.checked = false);
      document.getElementById('otherReasonText').value = '';
      document.getElementById('otherReasonContainer').style.display = 'none';
    }
  }
  
  function closeRejectModal() {
    const modal = document.getElementById('rejectModal');
    if (modal) {
      modal.classList.remove('active');
      currentRejectReportId = null;
    }
  }
  
  function handleRejectReasonChange() {
    const selected = document.querySelector('input[name="rejectReason"]:checked');
    const container = document.getElementById('otherReasonContainer');
    
    if (selected && selected.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
      container.style.display = 'block';
      setTimeout(() => document.getElementById('otherReasonText').focus(), 100);
    } else {
      container.style.display = 'none';
    }
  }
  
  async function confirmReject() {
    const selected = document.querySelector('input[name="rejectReason"]:checked');
    
    if (!selected) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
      return;
    }
    
    let reason = selected.value;
    
    if (reason === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
      const otherText = document.getElementById('otherReasonText').value.trim();
      if (!otherText) {
        alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
        document.getElementById('otherReasonText').focus();
        return;
      }
      reason = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ: ' + otherText;
    }
    
    const report = state.reports.find(r => r.id === currentRejectReportId);
    
    if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${report.reportNumber}?\n\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`)) {
      const updates = {
        status: 'rejected',
        rejectedReason: reason,
        rejectedAt: new Date().toISOString()
      };
      
      await updateReport(currentRejectReportId, updates);
      closeRejectModal();
      
      alert(`‚úÖ ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n\n‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${report.reportNumber}\n‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`);
    }
  }
  
  // ================== DASHBOARD ENHANCED ==================
  
  // State ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard
  const dashboardState = {
    filterPeriod: 'all',
    filterStartDate: null,
    filterEndDate: null,
    searchQuery: '',
    adminFilterPeriod: 'all',
    adminFilterStartDate: null,
    adminFilterEndDate: null,
    unitFilterPeriod: 'year', // default ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
    unitFilterStartDate: null,
    unitFilterEndDate: null,
    chartInstances: {}
  };
  
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  function filterReportsByDate(reports, period, startDate = null, endDate = null) {
    const now = new Date();
    
    return reports.filter(report => {
      if (!report.createdAt) return false;
      
      const reportDate = new Date(report.createdAt);
      
      switch(period) {
        case 'today':
          return reportDate.toDateString() === now.toDateString();
          
        case 'week':
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          return reportDate >= weekAgo;
          
        case 'month':
          return reportDate.getMonth() === now.getMonth() && 
                 reportDate.getFullYear() === now.getFullYear();
          
        case 'year':
          return reportDate.getFullYear() === now.getFullYear();
          
        case 'custom':
          if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59);
            return reportDate >= start && reportDate <= end;
          }
          return true;
          
        default:
          return true;
      }
    });
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  function createStatusChart(reports, canvasId) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    
    if (dashboardState.chartInstances[canvasId]) {
      dashboardState.chartInstances[canvasId].destroy();
    }
    
    const statusCounts = {
      pending: reports.filter(r => r.status === 'pending').length,
      assigned: reports.filter(r => r.status === 'assigned').length,
      resolved: reports.filter(r => r.status === 'resolved').length,
      approved: reports.filter(r => r.status === 'approved').length,
      rejected: reports.filter(r => r.status === 'rejected').length
    };
    
    dashboardState.chartInstances[canvasId] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'],
        datasets: [{
          data: [statusCounts.pending, statusCounts.assigned, statusCounts.resolved, statusCounts.approved, statusCounts.rejected],
          backgroundColor: ['#FCD34D', '#FB923C', '#C084FC', '#34D399', '#F87171']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { font: { family: 'Sarabun' } } },
          title: { display: true, text: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', font: { size: 14, weight: 'bold', family: 'Sarabun' } }
        }
      }
    });
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
  function createUnitChart(reports, canvasId) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    
    if (dashboardState.chartInstances[canvasId]) {
      dashboardState.chartInstances[canvasId].destroy();
    }
    
    const unitCounts = {};
    reports.forEach(report => {
      const unit = report.assignedTo || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢';
      unitCounts[unit] = (unitCounts[unit] || 0) + 1;
    });
    
    const sortedUnits = Object.entries(unitCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    
    dashboardState.chartInstances[canvasId] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sortedUnits.map(u => u[0]),
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
          data: sortedUnits.map(u => u[1]),
          backgroundColor: '#3B82F6'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Top 10 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', font: { size: 14, weight: 'bold', family: 'Sarabun' } }
        },
        scales: {
          x: { beginAtZero: true, ticks: { font: { family: 'Sarabun' } } },
          y: { ticks: { font: { family: 'Sarabun' } } }
        }
      }
    });
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡πà‡∏≠‡∏¢
  function createWorkerChart(reports, canvasId) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    
    if (dashboardState.chartInstances[canvasId]) {
      dashboardState.chartInstances[canvasId].destroy();
    }
    
    const workerCounts = {};
    reports.forEach(report => {
      const worker = report.workerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
      workerCounts[worker] = (workerCounts[worker] || 0) + 1;
    });
    
    const sortedWorkers = Object.entries(workerCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
    
    dashboardState.chartInstances[canvasId] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sortedWorkers.map(w => w[0]),
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          data: sortedWorkers.map(w => w[1]),
          backgroundColor: '#EF4444'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Top 10 ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î', font: { size: 14, weight: 'bold', family: 'Sarabun' } }
        },
        scales: {
          x: { beginAtZero: true, ticks: { font: { family: 'Sarabun' } } },
          y: { ticks: { font: { family: 'Sarabun' } } }
        }
      }
    });
  }
  
  // Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel
  function exportToExcel(reports, filename = 'unsafe-report.xlsx') {
    const data = reports.map(r => ({
      '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': r.reportNumber || '',
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå': r.incidentDate ? new Date(r.incidentDate).toLocaleDateString('th-TH') : '',
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': r.createdAt ? new Date(r.createdAt).toLocaleString('th-TH') : '',
      '‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': r.workerName || '',
      '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': r.workerUnit || '',
      '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î': r.description || '',
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': r.status === 'pending' ? '‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢' :
                r.status === 'assigned' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' :
                r.status === 'resolved' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' :
                r.status === 'approved' ? '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' :
                r.status === 'rejected' ? '‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' : '',
      '‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ': r.assignedTo || '',
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢': r.assignedAt ? new Date(r.assignedAt).toLocaleString('th-TH') : '',
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç': r.resolvedAt ? new Date(r.resolvedAt).toLocaleString('th-TH') : '',
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥': r.approvedAt ? new Date(r.approvedAt).toLocaleString('th-TH') : ''
    }));
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [
      { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 25 }, { wch: 40 },
      { wch: 15 }, { wch: 25 }, { wch: 20 }, { wch: 20 }, { wch: 20 }
    ];
    XLSX.utils.book_append_sheet(wb, ws, '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
    XLSX.writeFile(wb, filename);
  }
  
  // Export ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Admin only)
  function exportReporterStats(reports, filename = 'reporter-stats.xlsx') {
    const reporterCounts = {};
    reports.forEach(r => {
      const name = r.reporterName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
      if (!reporterCounts[name]) {
        reporterCounts[name] = {
          name: name,
          title: r.reporterTitle || '',
          unit: r.reporterUnit || '',
          count: 0
        };
      }
      reporterCounts[name].count++;
    });
    
    const data = Object.values(reporterCounts).sort((a, b) => b.count - a.count).map((r, index) => ({
      '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö': index + 1,
      '‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤': r.title,
      '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': r.name,
      '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô': r.unit,
      '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': r.count
    }));
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [{ wch: 8 }, { wch: 12 }, { wch: 25 }, { wch: 30 }, { wch: 20 }];
    XLSX.utils.book_append_sheet(wb, ws, '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
    XLSX.writeFile(wb, filename);
  }
  
  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
  function handlePeriodChange(period) {
    dashboardState.filterPeriod = period;
    const customRange = document.getElementById('customDateRange');
    if (customRange) {
      customRange.style.display = period === 'custom' ? 'block' : 'none';
    }
    if (period !== 'custom') {
      render();
    }
  }
  
  // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
  function applyCustomFilter() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (!startDate || !endDate) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
      return;
    }
    dashboardState.filterStartDate = startDate;
    dashboardState.filterEndDate = endDate;
    render();
  }
  
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Dashboard
  function handleDashboardSearch(event) {
    if (event.key === 'Enter') {
      applyDashboardSearch();
    }
  }
  
  function applyDashboardSearch() {
    const searchInput = document.getElementById('dashboardSearch');
    if (searchInput) {
      dashboardState.searchQuery = searchInput.value.trim();
      render();
    }
  }
  
  function clearDashboardSearch() {
    dashboardState.searchQuery = '';
    render();
  }
  
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  function showReportDetailModal(reportId) {
    const report = state.reports.find(r => r.id === reportId);
    if (!report) return;
    
    const modal = document.getElementById('reportDetailModal');
    const content = document.getElementById('reportDetailContent');
    
    if (!modal || !content) return;
    
    const statusText = {
      'pending': '‚è≥ ‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢',
      'assigned': 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
      'resolved': '‚è±Ô∏è ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
      'approved': '‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
      'rejected': '‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'
    };
    
    const statusColor = {
      'pending': 'bg-yellow-100 text-yellow-800',
      'assigned': 'bg-orange-100 text-orange-800',
      'resolved': 'bg-purple-100 text-purple-800',
      'approved': 'bg-green-100 text-green-800',
      'rejected': 'bg-red-100 text-red-800'
    };
    
    content.innerHTML = `
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-xl font-bold text-purple-600">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
        <button onclick="closeReportDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <div class="mb-4">
        <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColor[report.status] || 'bg-gray-100'}">
          ${statusText[report.status] || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'}
        </span>
      </div>
      
      <div class="space-y-4">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="font-bold text-blue-800 mb-2">üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <p><span class="font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</span> ${report.reportNumber || '-'}</p>
            <p><span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</span> ${report.createdAt ? new Date(report.createdAt).toLocaleString('th-TH') : '-'}</p>
            <p><span class="font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:</span> ${report.incidentDate ? new Date(report.incidentDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'}) : '-'}</p>
          </div>
        </div>
        
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
        <div class="bg-orange-50 p-4 rounded-lg">
          <h4 class="font-bold text-orange-800 mb-2">üë§ ‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h4>
          <div class="text-sm">
            <p><span class="font-semibold">‡∏ä‡∏∑‡πà‡∏≠:</span> ${report.workerName || '-'}</p>
            <p><span class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</span> ${report.workerUnit || '-'}</p>
          </div>
        </div>
        
        <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="font-bold text-gray-800 mb-2">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</h4>
          <p class="text-sm whitespace-pre-wrap">${report.description || '-'}</p>
        </div>
        
        <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö -->
        ${report.images && report.images.length > 0 ? `
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="font-bold text-gray-800 mb-2">üì∑ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (${report.images.length} ‡∏£‡∏π‡∏õ)</h4>
          <div class="grid grid-cols-3 gap-2">
            ${report.images.map((img, idx) => `
              <img src="${img}" class="w-full h-24 object-cover rounded cursor-pointer hover:opacity-80" onclick="showImageModal('${img}')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">
            `).join('')}
          </div>
        </div>
        ` : ''}
        
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ -->
        ${report.assignedTo ? `
        <div class="bg-purple-50 p-4 rounded-lg">
          <h4 class="font-bold text-purple-800 mb-2">üè¢ ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h4>
          <p class="text-sm"><span class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</span> ${report.assignedTo}</p>
          <p class="text-sm"><span class="font-semibold">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span> ${report.assignedAt ? new Date(report.assignedAt).toLocaleString('th-TH') : '-'}</p>
        </div>
        ` : ''}
        
        <!-- ‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
        ${report.resolveImages && report.resolveImages.length > 0 ? `
        <div class="bg-green-50 p-4 rounded-lg">
          <h4 class="font-bold text-green-800 mb-2">üîß ‡∏£‡∏π‡∏õ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ô‡∏≤‡∏° (${report.resolveImages.length} ‡∏£‡∏π‡∏õ)</h4>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            ${report.resolveImages.map((img, idx) => `
              <div class="relative group">
                <img src="${img}" class="w-full h-32 object-cover rounded cursor-pointer hover:opacity-80 border-2 border-green-300" onclick="showImageWithDownload('${img}', '${report.reportNumber}_‡∏£‡∏π‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç_${idx+1}')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î">
                <div class="absolute bottom-1 right-1 flex gap-1">
                  <button onclick="event.stopPropagation(); showImageWithDownload('${img}', '${report.reportNumber}_‡∏£‡∏π‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç_${idx+1}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700" title="‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏°">
                    üëÅÔ∏è
                  </button>
                  <button onclick="event.stopPropagation(); downloadImage('${img}', '${report.reportNumber}_‡∏£‡∏π‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç_${idx+1}')" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î">
                    üíæ
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          ${report.resolveNote ? `<p class="text-sm mt-2"><span class="font-semibold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> ${report.resolveNote}</p>` : ''}
          <p class="text-sm"><span class="font-semibold">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span> ${report.resolvedAt ? new Date(report.resolvedAt).toLocaleString('th-TH') : '-'}</p>
        </div>
        ` : ''}
        
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
        ${report.status === 'approved' ? `
        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
          <h4 class="font-bold text-green-800 mb-2">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</h4>
          <p class="text-sm"><span class="font-semibold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span> ${report.approvedAt ? new Date(report.approvedAt).toLocaleString('th-TH') : '-'}</p>
        </div>
        ` : ''}
        
        <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò -->
        ${report.status === 'rejected' ? `
        <div class="bg-red-50 p-4 rounded-lg border-2 border-red-300">
          <h4 class="font-bold text-red-800 mb-2">‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h4>
          <p class="text-sm"><span class="font-semibold">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</span> ${report.rejectedReason || '-'}</p>
        </div>
        ` : ''}
        
        <!-- ‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
        ${report.signedDocumentUrl ? `
        <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
          <h4 class="font-bold text-yellow-800 mb-2">üìÑ ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</h4>
          <img src="${report.signedDocumentUrl}" class="w-full rounded cursor-pointer hover:opacity-80" onclick="showImageModal('${report.signedDocumentUrl}')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà">
          <p class="text-sm mt-2"><span class="font-semibold">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span> ${report.signedDocumentUploadedAt ? new Date(report.signedDocumentUploadedAt).toLocaleString('th-TH') : '-'}</p>
        </div>
        ` : ''}
      </div>
      
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ -->
      <div class="mt-6 flex flex-wrap gap-2">
        ${report.status === 'approved' ? `
          <button onclick="printWarningLetter('${report.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">
            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          </button>
          ${!report.signedDocumentUrl ? `
          <button onclick="closeReportDetailModal(); showUploadSignedDocModal('${report.id}')" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm font-semibold">
            üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß
          </button>
          ` : ''}
        ` : ''}
        <button onclick="closeReportDetailModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 text-sm font-semibold">
          ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    `;
    
    modal.classList.add('active');
  }
  
  function closeReportDetailModal() {
    const modal = document.getElementById('reportDetailModal');
    if (modal) {
      modal.classList.remove('active');
    }
  }
  
  // Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß
  let currentUploadReportId = null;
  
  function showUploadSignedDocModal(reportId) {
    currentUploadReportId = reportId;
    const report = state.reports.find(r => r.id === reportId);
    if (!report) return;
    
    const modalHtml = `
      <div id="uploadSignedDocModal" class="modal active" onclick="closeUploadSignedDocModal()">
        <div class="bg-white rounded-2xl p-6 max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold mb-4 text-yellow-600">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß</h3>
          <p class="text-sm text-gray-600 mb-4">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <strong>${report.reportNumber}</strong></p>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label>
            <input type="file" id="signedDocFile" accept="image/*" onchange="previewSignedDoc(event)"
              class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm">
          </div>
          
          <div id="signedDocPreview" class="mb-4 hidden">
            <img id="signedDocImg" class="w-full rounded border">
          </div>
          
          <div class="flex gap-3">
            <button onclick="closeUploadSignedDocModal()" 
              class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-semibold">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="uploadSignedDoc()" 
              class="flex-1 bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 font-semibold">
              ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
            </button>
          </div>
        </div>
      </div>
    `;
    
    // ‡∏•‡∏ö modal ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const existingModal = document.getElementById('uploadSignedDocModal');
    if (existingModal) existingModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  
  function closeUploadSignedDocModal() {
    const modal = document.getElementById('uploadSignedDocModal');
    if (modal) modal.remove();
    currentUploadReportId = null;
  }
  
  function previewSignedDoc(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('signedDocImg').src = e.target.result;
        document.getElementById('signedDocPreview').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  }
  
  async function uploadSignedDoc() {
    if (!currentUploadReportId) return;
    
    const fileInput = document.getElementById('signedDocFile');
    if (!fileInput.files[0]) {
      alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
      return;
    }
    
    const file = fileInput.files[0];
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
    const uploadBtn = event.target;
    uploadBtn.disabled = true;
    uploadBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
    
    try {
      // ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ ImgBB
      const compressedBase64 = await compressImage(file, 1200, 0.8);
      const formData = new FormData();
      formData.append('image', compressedBase64.split(',')[1]);
      
      const response = await fetch('https://api.imgbb.com/1/upload?key=5e3d6c6e3e1e8a9f8e5f6d5c4b3a2a1b', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (result.success) {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡∏•‡∏á Firebase
        await updateReport(currentUploadReportId, {
          signedDocumentUrl: result.data.url,
          signedDocumentUploadedAt: new Date().toISOString()
        });
        
        alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        closeUploadSignedDocModal();
        render();
      } else {
        throw new Error('Upload failed');
      }
    } catch (error) {
      console.error('Upload error:', error);
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
      uploadBtn.disabled = false;
      uploadBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
    }
  }
  
  // Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
  function exportCurrentData() {
    const filteredReports = filterReportsByDate(
      state.reports,
      dashboardState.filterPeriod,
      dashboardState.filterStartDate,
      dashboardState.filterEndDate
    );
    const period = dashboardState.filterPeriod === 'custom' 
      ? `${dashboardState.filterStartDate}-${dashboardState.filterEndDate}`
      : dashboardState.filterPeriod;
    exportToExcel(filteredReports, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô-${period}.xlsx`);
  }
  
  // Admin Filter Handlers
  function handleAdminPeriodChange(period) {
    dashboardState.adminFilterPeriod = period;
    
    const customRange = document.getElementById('adminCustomDateRange');
    if (customRange) {
      customRange.style.display = period === 'custom' ? 'flex' : 'none';
    }
    
    if (period !== 'custom') {
      render();
    }
  }
  
  function applyAdminCustomFilter() {
    const startDate = document.getElementById('adminStartDate').value;
    const endDate = document.getElementById('adminEndDate').value;
    
    if (!startDate || !endDate) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
      return;
    }
    
    dashboardState.adminFilterStartDate = startDate;
    dashboardState.adminFilterEndDate = endDate;
    render();
  }
  
  function exportAdminReporterStats() {
    const filteredReports = filterReportsByDate(
      state.reports.filter(r => r.status !== 'pending'), // ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
      dashboardState.adminFilterPeriod,
      dashboardState.adminFilterStartDate,
      dashboardState.adminFilterEndDate
    );
    const period = dashboardState.adminFilterPeriod === 'custom' 
      ? `${dashboardState.adminFilterStartDate}-${dashboardState.adminFilterEndDate}`
      : dashboardState.adminFilterPeriod;
    exportReporterStats(filteredReports, `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô-${period}.xlsx`);
  }
  
  // Unit Filter Handlers
  function handleUnitPeriodChange(period) {
    dashboardState.unitFilterPeriod = period;
    
    const customRange = document.getElementById('unitCustomDateRange');
    if (customRange) {
      customRange.style.display = period === 'custom' ? 'block' : 'none';
    }
    
    if (period !== 'custom') {
      render();
    }
  }
  
  function applyUnitCustomFilter() {
    const startDate = document.getElementById('unitStartDate').value;
    const endDate = document.getElementById('unitEndDate').value;
    
    if (!startDate || !endDate) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
      return;
    }
    
    dashboardState.unitFilterStartDate = startDate;
    dashboardState.unitFilterEndDate = endDate;
    render();
  }
  
  // ================== INIT ==================
  // ================== INIT ==================
  async function init() {
    console.log('üöÄ Initializing Unsafe-Report with Firebase...');
    
    try {
      // 0. Check URL parameters for direct navigation (Rich Menu)
      const urlParams = new URLSearchParams(window.location.search);
      const pageParam = urlParams.get('page');
      if (pageParam && ['report', 'tracking', 'dashboard', 'admin'].includes(pageParam)) {
        state.page = pageParam;
        console.log('üìç Direct navigation to:', pageParam);
      }
      
      // 1. Initialize Firebase
      if (typeof firebase === 'undefined') {
        throw new Error('Firebase SDK not loaded');
      }
      
      firebaseApp = firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      isFirebaseReady = true;
      console.log('‚úÖ Firebase initialized successfully');
      
      // 2. Load initial data
      await loadReports();
      
      // 3. Setup real-time sync
      setupRealtimeListeners();
      
      // 4. Render UI
      render();
      
      console.log('‚úÖ App initialized successfully!');
      console.log('üîÑ Real-time sync is active - changes will appear instantly!');
      
    } catch (error) {
      console.error('‚ùå Initialization error:', error);
      alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏î‡πâ\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤:\n1. Refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (Ctrl+Shift+R)\n2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Internet\n3. ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Incognito\n\nError: ' + error.message);
    }
  }
  
  // Start app
  window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
